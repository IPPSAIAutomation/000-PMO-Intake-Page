<script>
    /**
     * ========================================
     * PMO INTAKE DASHBOARD - TASK MANAGEMENT WORKSPACE
     * ========================================
     */

    // Global state
    let currentTab = 'DB_ADHOCS';
    let currentView = 'myTasks'; // 'myTasks' or 'allRequests'
    let currentProjectView = 'pending'; // 'pending', 'roadmap', or 'archive'
    let currentData = null;
    let teamMembers = [];
    let userEmail = '';
    let initTimeout = null;

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function () {
        initializeDashboard();
    });

    /**
     * Initialize the dashboard
     */
    function initializeDashboard() {
        // Set a timeout to catch stuck initialization
        initTimeout = setTimeout(() => {
            console.error('Initialization timeout - Google Apps Script may not be responding');
            hideLoading();
            showError('Unable to load data. This may be due to a slow connection or script timeout. Please refresh the page to try again.');
        }, 30000); // 30 second timeout

        // Set user email from server
        google.script.run
            .withSuccessHandler(function (email) {
                userEmail = email;

                // Extract name from email (part before @)
                const userName = email.split('@')[0];
                // Capitalize first letter of each word (e.g., "ipalacio" -> "Ipalacio")
                const displayName = userName.charAt(0).toUpperCase() + userName.slice(1);

                document.getElementById('userEmail').textContent = email;
                document.querySelector('.user-name').textContent = displayName;

                // Set user avatar (first letter of name)
                const firstLetter = displayName.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;

                // Now load team members and data
                loadTeamMembersAndData();
            })
            .withFailureHandler(function (error) {
                console.error('Error getting user email:', error);
                clearTimeout(initTimeout);
                hideLoading();
                showError('Failed to load user information: ' + error.message + '. Please refresh the page.');

                // Try to continue with fallback
                userEmail = 'unknown@ucsd.edu';
                document.getElementById('userEmail').textContent = 'Error loading email';
                document.querySelector('.user-name').textContent = 'Unknown User';
                loadTeamMembersAndData();
            })
            .getUserEmail();
    }

    /**
     * Load team members and initial data
     * Called after user email is retrieved
     */
    function loadTeamMembersAndData() {
        // Load team members
        google.script.run
            .withSuccessHandler(function (members) {
                teamMembers = members;
                // Load initial data after team members are loaded
                loadData(currentTab);
            })
            .withFailureHandler(function (error) {
                console.error('Error loading team members:', error);
                clearTimeout(initTimeout);
                hideLoading();
                showError('Failed to load team members: ' + error.message + '. Some features may not work correctly.');

                // Load data anyway with empty team list
                teamMembers = [];
                loadData(currentTab);
            })
            .getTeamMembers();
    }

    /**
     * Switch between tabs
     * @param {string} tabName - Name of the tab to switch to
     */
    function switchTab(tabName) {
        // Update active state on sidebar nav buttons
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.classList.remove('active');
        });

        const activeButton = tabName === 'DB_ADHOCS' ?
            document.getElementById('nav-adhoc') :
            document.getElementById('nav-pending'); // Default to pending view for projects

        activeButton.classList.add('active');

        // Update current tab
        currentTab = tabName;

        // If switching to projects, default to pending view
        if (tabName === 'DB_PROJECTS') {
            currentProjectView = 'pending';
        }

        // Update top bar title
        const title = tabName === 'DB_ADHOCS' ? 'Ad Hoc Requests Queue' : 'Project Intake & Prioritization';
        document.getElementById('topBarTitle').textContent = title;

        // Show/hide stats section (only for Ad Hoc Requests)
        const statsSection = document.querySelector('.stats-section');
        if (statsSection) {
            if (tabName === 'DB_ADHOCS') {
                statsSection.style.display = 'block';
            } else {
                statsSection.style.display = 'none';
            }
        }

        // Show/hide filters bar (only for Ad Hoc Requests)
        const filtersBar = document.querySelector('.filters-bar');
        if (tabName === 'DB_ADHOCS') {
            filtersBar.style.display = 'flex';
        } else {
            filtersBar.style.display = 'none';
        }

        // Hide matrix container for Ad Hoc tab
        const matrixContainer = document.getElementById('matrixContainer');
        if (matrixContainer) {
            if (tabName === 'DB_ADHOCS') {
                matrixContainer.classList.add('hidden');
            }
            // Note: Matrix visibility for project views is handled in renderProjectTable()
        }

        // Update table headers based on tab
        updateTableHeaders(tabName);

        // Load data
        loadData(tabName);
    }

    /**
     * Switch between project views
     * @param {string} viewName - Name of the project view ('pending', 'roadmap', 'archive')
     */
    function switchProjectView(viewName) {
        // Update active state on sidebar nav buttons
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.classList.remove('active');
        });

        // Activate the clicked button
        const buttonId = `nav-${viewName}`;
        const activeButton = document.getElementById(buttonId);
        if (activeButton) {
            activeButton.classList.add('active');
        }

        // Update current tab and view
        currentTab = 'DB_PROJECTS';
        currentProjectView = viewName;

        // Update top bar title based on view
        const titles = {
            'pending': 'Project Intake & Prioritization - Pending Review',
            'roadmap': 'Project Intake & Prioritization - Active Roadmap',
            'archive': 'Project Intake & Prioritization - Archive'
        };
        document.getElementById('topBarTitle').textContent = titles[viewName] || 'Project Intake & Prioritization';

        // Hide stats section (not used for projects)
        const statsSection = document.querySelector('.stats-section');
        if (statsSection) {
            statsSection.style.display = 'none';
        }

        // Hide filters bar (not used for projects)
        const filtersBar = document.querySelector('.filters-bar');
        filtersBar.style.display = 'none';

        // Update table headers
        updateTableHeaders('DB_PROJECTS');

        // Load data
        loadData('DB_PROJECTS');
    }

    /**
     * Update table headers based on current tab
     */
    function updateTableHeaders(tabName) {
        const tableHead = document.querySelector('thead tr');

        if (tabName === 'DB_PROJECTS') {
            // Project table headers - vary by view
            if (currentProjectView === 'pending') {
                tableHead.innerHTML = `
                    <th>Project Title</th>
                    <th>Executive Sponsor</th>
                    <th>Status</th>
                    <th>Tech Effort</th>
                    <th>AI Strategy</th>
                `;
            } else {
                // roadmap and archive views
                tableHead.innerHTML = `
                    <th>Project Title</th>
                    <th>Executive Sponsor</th>
                    <th>Status</th>
                    <th>Final Score</th>
                `;
            }
        } else {
            // Ad Hoc table headers
            tableHead.innerHTML = `
                <th>Request</th>
                <th>Status</th>
                <th>Assignee</th>
                <th>Deadline</th>
                <th style="width: 48px; text-align: right;">Action</th>
            `;
        }
    }

    /**
     * Switch between views (My Active Tasks vs All Requests)
     * @param {string} viewName - Name of the view
     */
    function switchView(viewName) {
        // Update active state on filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        const activeButton = viewName === 'myTasks' ?
            document.getElementById('filter-my') :
            document.getElementById('filter-all');

        activeButton.classList.add('active');

        // Update current view
        currentView = viewName;

        // Re-render table with filtered data
        if (currentData) {
            renderTable(currentData);
        }
    }

    /**
     * Load data from the server
     * @param {string} tabName - Name of the tab to load data from
     */
    function loadData(tabName) {
        // Show loading state
        showLoading();

        // Call server-side function
        google.script.run
            .withSuccessHandler(onDataLoaded)
            .withFailureHandler(onDataError)
            .getData(tabName);
    }

    /**
     * Handle successful data load
     * @param {Object} data - Data object with headers and rows
     */
    function onDataLoaded(data) {
        // Clear initialization timeout if it exists
        if (initTimeout) {
            clearTimeout(initTimeout);
            initTimeout = null;
        }

        currentData = data;

        // Hide loading state
        hideLoading();

        // Check if data is empty
        if (!data.rows || data.rows.length === 0) {
            showEmptyState();
            return;
        }

        // Render table
        renderTable(data);
    }

    /**
     * Handle data load error
     * @param {Error} error - Error object
     */
    function onDataError(error) {
        // Clear initialization timeout if it exists
        if (initTimeout) {
            clearTimeout(initTimeout);
            initTimeout = null;
        }

        console.error('Error loading data:', error);
        hideLoading();

        // Show user-friendly error message
        const errorMsg = error.message || 'Unknown error occurred';
        showError(`Failed to load data: ${errorMsg}. Please try refreshing the page or contact support if the issue persists.`);
    }

    /**
     * Filter data based on current view
     * @param {Object} data - Original data
     * @returns {Object} Filtered data
     */
    function filterData(data) {
        // Only filter for Ad Hoc Requests in "My Active Tasks" view
        if (currentTab !== 'DB_ADHOCS' || currentView !== 'myTasks') {
            console.log('Not filtering - currentTab:', currentTab, 'currentView:', currentView);
            return data;
        }

        console.log('Filter Debug - Current user email:', userEmail);

        const assigneeIndex = data.headers.indexOf('Assignee');
        const statusIndex = data.headers.indexOf('Status');

        if (assigneeIndex === -1 || statusIndex === -1) {
            console.warn('Missing required columns - Assignee index:', assigneeIndex, 'Status index:', statusIndex);
            return data;
        }

        // Filter rows where Assignee matches current user AND Status is not "Completed"
        const filteredRows = data.rows.filter(row => {
            const assignee = row[assigneeIndex];
            const status = row[statusIndex];

            // Match assignee (case-insensitive, partial match on email)
            const isMyTask = assignee && assignee.toLowerCase().includes(userEmail.toLowerCase());
            const isNotCompleted = status !== 'Completed';

            // Debug log for each row
            if (assignee) {
                console.log(`Row - Assignee: "${assignee}", Status: "${status}", Match: ${isMyTask}, NotCompleted: ${isNotCompleted}`);
            }

            return isMyTask && isNotCompleted;
        });

        console.log(`‚úÖ Filtered ${filteredRows.length} rows from ${data.rows.length} total rows`);

        return {
            headers: data.headers,
            rows: filteredRows
        };
    }

    /**
     * Render the data table
     * @param {Object} data - Data object with headers and rows
     */
    function renderTable(data) {
        const tableBody = document.getElementById('tableBody');
        const dataGridSection = document.getElementById('dataGridSection');

        // Filter data based on current view
        const filteredData = filterData(data);

        // Calculate stats
        calculateStats(filteredData);

        // Check if filtered data is empty
        if (filteredData.rows.length === 0) {
            showEmptyState();
            return;
        }

        // Clear existing content
        tableBody.innerHTML = '';

        // Render based on current tab
        if (currentTab === 'DB_PROJECTS') {
            renderProjectTable(filteredData, data.headers, tableBody);
        } else {
            renderAdHocTable(filteredData, data.headers, tableBody);
        }

        // Show table
        dataGridSection.style.display = 'block';
        document.getElementById('emptyState').classList.add('hidden');
    }

    /**
     * Render Ad Hoc Requests Table
     */
    function renderAdHocTable(filteredData, headers, tableBody) {
        // Get column indices
        const titleIndex = headers.indexOf('The Request');
        const statusIndex = headers.indexOf('Status');
        const assigneeIndex = headers.indexOf('Assignee');
        const deadlineIndex = headers.indexOf('Hard Deadline');
        const idIndex = headers.indexOf('Timestamp');
        const requestorIndex = headers.indexOf('Email Address');

        // Create data rows
        filteredData.rows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.dataset.rowIndex = rowIndex;
            tr.onclick = () => openDetails(row, headers);

            // Request Column (Title + Metadata)
            const tdRequest = document.createElement('td');
            const title = row[titleIndex] || 'Untitled Request';
            const requestor = row[requestorIndex] || 'Unknown';
            const timestamp = formatTimestamp(row[idIndex]);
            const requestId = generateRequestId(rowIndex);

            tdRequest.innerHTML = `
                <div class="request-title">${escapeHtml(title)}</div>
                <div class="request-meta">
                    ${requestId} ‚Ä¢ ${escapeHtml(requestor.split('@')[0])} ‚Ä¢ <span>${timestamp}</span>
                </div>
            `;
            tr.appendChild(tdRequest);

            // Status Column
            const tdStatus = document.createElement('td');
            const status = row[statusIndex] || 'New';
            tdStatus.innerHTML = renderStatusBadge(status);
            tr.appendChild(tdStatus);

            // Assignee Column
            const tdAssignee = document.createElement('td');
            const assignee = row[assigneeIndex];
            tdAssignee.innerHTML = renderAssigneeCell(assignee);
            tr.appendChild(tdAssignee);

            // Deadline Column
            const tdDeadline = document.createElement('td');
            const deadline = row[deadlineIndex];
            tdDeadline.innerHTML = renderDeadlineCell(deadline);
            tr.appendChild(tdDeadline);

            // Action Column (Chevron)
            const tdAction = document.createElement('td');
            tdAction.style.textAlign = 'right';
            tdAction.innerHTML = '<span class="chevron-icon">‚Ä∫</span>';
            tr.appendChild(tdAction);

            tableBody.appendChild(tr);
        });
    }

    /**
     * Render Project Requests Table
     */
    function renderProjectTable(filteredData, headers, tableBody) {
        // Get column indices
        const titleIndex = headers.indexOf('Project Title');
        const sponsorIndex = headers.indexOf('Executive Sponsor');
        const statusIndex = headers.indexOf('Status');
        const techEffortIndex = headers.indexOf('Tech Effort');
        const finalScoreIndex = headers.indexOf('Final Score');
        const aiStrategyIndex = headers.indexOf('AI Strategy Score');
        const aiImpactIndex = headers.indexOf('AI Impact Score');

        // Filter data based on current project view
        let viewFilteredRows = filteredData.rows;
        if (currentProjectView === 'pending') {
            viewFilteredRows = filteredData.rows.filter(row => {
                const status = row[statusIndex] || '';
                // Treat blank/empty status as "Pending Review" (new submissions)
                return status === 'Pending Review' || status === 'New' || status === '' || status.trim() === '';
            });
        } else if (currentProjectView === 'roadmap') {
            viewFilteredRows = filteredData.rows.filter(row => {
                const status = row[statusIndex] || '';
                return status === 'Approved' || status === 'In Progress';
            });
            // Sort by Final Score descending (highest priority first)
            viewFilteredRows.sort((a, b) => {
                const scoreA = parseFloat(a[finalScoreIndex]) || 0;
                const scoreB = parseFloat(b[finalScoreIndex]) || 0;
                return scoreB - scoreA; // Descending order
            });
        } else if (currentProjectView === 'archive') {
            viewFilteredRows = filteredData.rows.filter(row => {
                const status = row[statusIndex] || '';
                return status === 'Completed' || status === 'Rejected';
            });
        }

        // Show/hide matrix container based on view
        const matrixContainer = document.getElementById('matrixContainer');
        if (currentProjectView === 'pending') {
            matrixContainer.classList.remove('hidden');
            // Render matrix bubbles
            renderMatrixBubbles(viewFilteredRows, headers);
        } else {
            matrixContainer.classList.add('hidden');
        }

        // Create data rows
        viewFilteredRows.forEach((row, rowIndex) => {
            // Find the original row index in the full dataset
            const originalRowIndex = filteredData.rows.indexOf(row);

            const tr = document.createElement('tr');
            tr.dataset.rowIndex = originalRowIndex;

            // Only attach onclick for 'roadmap' view
            if (currentProjectView === 'roadmap') {
                tr.onclick = () => openDetails(row, headers);
                tr.style.cursor = 'pointer';
            } else {
                tr.style.cursor = 'default';
            }

            // Project Title Column
            const tdTitle = document.createElement('td');
            const title = row[titleIndex] || 'Untitled Project';
            const projectId = `PROJ-${String(originalRowIndex + 1).padStart(3, '0')}`;

            tdTitle.innerHTML = `
                <div class="request-title">${escapeHtml(title)}</div>
                <div class="request-meta">${projectId}</div>
            `;
            tr.appendChild(tdTitle);

            // Executive Sponsor Column
            const tdSponsor = document.createElement('td');
            const sponsor = row[sponsorIndex] || 'Unknown';
            tdSponsor.innerHTML = `<span style="color: var(--slate-600); font-size: 0.875rem;">${escapeHtml(sponsor)}</span>`;
            tr.appendChild(tdSponsor);

            // Status Column
            const tdStatus = document.createElement('td');
            const status = row[statusIndex] || 'Pending Review';
            // Use blue badge with play icon for "In Progress" in roadmap view
            if (currentProjectView === 'roadmap' && status === 'In Progress') {
                tdStatus.innerHTML = `<span class="status-badge status-in-progress-blue">${escapeHtml(status)}</span>`;
            } else {
                tdStatus.innerHTML = renderStatusBadge(status);
            }
            tr.appendChild(tdStatus);

            // View-specific columns
            if (currentProjectView === 'pending') {
                // Tech Effort Column (Visual bars)
                const tdEffort = document.createElement('td');
                const techEffort = parseInt(row[techEffortIndex]) || 0;

                const bars = [1, 2, 3].map(level => {
                    const isActive = techEffort >= level;
                    return `<div style="width: 0.5rem; height: 1rem; border-radius: 0.125rem; background: ${isActive ? 'var(--slate-400)' : 'var(--slate-100)'}; display: inline-block;"></div>`;
                }).join('');

                tdEffort.innerHTML = `<div style="display: flex; gap: 0.25rem;">${bars}</div>`;
                tr.appendChild(tdEffort);

                // AI Strategy Score Column
                const tdAiScore = document.createElement('td');
                const aiScore = parseInt(row[aiStrategyIndex]) || 0;
                tdAiScore.innerHTML = `<span style="font-family: monospace; font-weight: 600; color: var(--slate-700); font-size: 0.875rem;">${aiScore > 0 ? aiScore : '-'}</span>`;
                tr.appendChild(tdAiScore);
            } else {
                // Score Column (for roadmap and archive)
                const tdScore = document.createElement('td');
                const finalScore = parseFloat(row[finalScoreIndex]) || 0;
                tdScore.innerHTML = `<span style="font-family: monospace; font-weight: 700; color: var(--slate-700); font-size: 0.875rem;">${finalScore > 0 ? finalScore.toFixed(1) : '-'}</span>`;
                tr.appendChild(tdScore);
            }

            tableBody.appendChild(tr);
        });
    }

    /**
     * Render matrix bubbles for pending project view
     * @param {Array} rows - Filtered project rows
     * @param {Array} headers - Column headers
     */
    function renderMatrixBubbles(rows, headers) {
        const bubblesContainer = document.getElementById('matrixBubbles');
        if (!bubblesContainer) return;

        // Clear existing bubbles
        bubblesContainer.innerHTML = '';

        // Get column indices
        const titleIndex = headers.indexOf('Project Title');
        const techEffortIndex = headers.indexOf('Tech Effort');
        const aiStrategyIndex = headers.indexOf('AI Strategy Score');
        const aiImpactIndex = headers.indexOf('AI Impact Score');

        rows.forEach((row, index) => {
            const title = row[titleIndex] || 'Untitled';
            const techEffort = parseInt(row[techEffortIndex]) || 1;
            const aiStrategy = parseInt(row[aiStrategyIndex]) || 0;
            const aiImpact = parseInt(row[aiImpactIndex]) || 0;

            // Skip if no AI scores
            if (aiStrategy === 0 && aiImpact === 0) return;

            // Calculate position (0-100%)
            const position = calculateBubblePosition(techEffort, aiStrategy);

            // Calculate size based on impact (20-60px)
            const size = 20 + (aiImpact / 10) * 40;

            // Get color based on quadrant
            const color = getQuadrantColor(techEffort, aiStrategy);

            // Create bubble element
            const bubble = document.createElement('div');
            bubble.className = 'matrix-bubble';
            bubble.style.left = `${position.x}%`;
            bubble.style.top = `${position.y}%`;
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;
            bubble.style.background = color.bg;
            bubble.style.borderColor = color.border;
            bubble.style.transform = 'translate(-50%, -50%)';

            // Add tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'matrix-bubble-tooltip';
            tooltip.textContent = `${title} (Strategy: ${aiStrategy}, Impact: ${aiImpact}, Effort: ${techEffort})`;
            bubble.appendChild(tooltip);

            bubblesContainer.appendChild(bubble);
        });
    }

    /**
     * Calculate bubble position on matrix
     * @param {number} techEffort - Tech effort (1-3)
     * @param {number} aiStrategy - AI strategy score (1-10)
     * @returns {Object} Position {x, y} in percentage
     */
    function calculateBubblePosition(techEffort, aiStrategy) {
        // X-axis: Tech Effort (1-3) -> 0-100%
        // Lower effort = left (0%), higher effort = right (100%)
        const x = ((techEffort - 1) / 2) * 100;

        // Y-axis: AI Strategy Score (1-10) -> 100-0% (inverted because high is at top)
        // Higher strategy = top (0%), lower strategy = bottom (100%)
        const y = 100 - ((aiStrategy - 1) / 9) * 100;

        return { x, y };
    }

    /**
     * Get quadrant color based on position
     * @param {number} techEffort - Tech effort (1-3)
     * @param {number} aiStrategy - AI strategy score (1-10)
     * @returns {Object} Color {bg, border}
     */
    function getQuadrantColor(techEffort, aiStrategy) {
        const isHighEffort = techEffort >= 2;
        const isHighStrategy = aiStrategy >= 6;

        if (isHighStrategy && !isHighEffort) {
            // Q1: High Impact, Low Effort (Green)
            return { bg: 'rgba(16, 185, 129, 0.6)', border: 'rgba(16, 185, 129, 0.8)' };
        } else if (isHighStrategy && isHighEffort) {
            // Q2: High Impact, High Effort (Blue)
            return { bg: 'rgba(59, 130, 246, 0.6)', border: 'rgba(59, 130, 246, 0.8)' };
        } else if (!isHighStrategy && isHighEffort) {
            // Q3: Low Impact, High Effort (Red)
            return { bg: 'rgba(239, 68, 68, 0.6)', border: 'rgba(239, 68, 68, 0.8)' };
        } else {
            // Q4: Low Impact, Low Effort (Slate)
            return { bg: 'rgba(100, 116, 139, 0.6)', border: 'rgba(100, 116, 139, 0.8)' };
        }
    }

    /**
     * Toggle scoring guide modal
     */
    function toggleScoringModal() {
        const modal = document.getElementById('scoringModal');
        if (modal) {
            modal.classList.toggle('hidden');
        }
    }

    /**
     * Calculate and update stats
     * @param {Object} data - Filtered data
     */
    function calculateStats(data) {
        const total = data.rows.length;

        // Calculate urgent (due < 48 hours)
        const deadlineIndex = currentData.headers.indexOf('Hard Deadline');
        const now = new Date();
        let urgent = 0;

        data.rows.forEach(row => {
            const deadlineStr = row[deadlineIndex];
            if (deadlineStr) {
                try {
                    const deadline = new Date(deadlineStr);
                    const diffHours = (deadline - now) / (1000 * 60 * 60);
                    if (diffHours > 0 && diffHours <= 48) {
                        urgent++;
                    }
                } catch (e) {
                    // Ignore invalid dates
                }
            }
        });

        // Calculate new count for badge
        const statusIndex = currentData.headers.indexOf('Status');
        const newCount = currentData.rows.filter(row => row[statusIndex] === 'New').length;

        // Update UI
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-urgent').textContent = urgent;
        document.getElementById('badge-new').textContent = newCount;
    }

    /**
     * Render priority icon
     * @param {string} priority - Priority value
     * @returns {string} HTML
     */
    function renderPriorityIcon(priority) {
        const priorityLower = String(priority).toLowerCase();

        if (priorityLower.includes('high')) {
            return '<div class="priority-icon priority-high">‚ö†</div>';
        } else if (priorityLower.includes('medium')) {
            return '<div class="priority-icon"><div class="priority-medium"></div></div>';
        } else {
            return '<div class="priority-icon"><div class="priority-low"></div></div>';
        }
    }

    /**
     * Render status badge
     * @param {string} status - Status value
     * @returns {string} HTML
     */
    function renderStatusBadge(status) {
        const statusLower = String(status).toLowerCase();
        let className = 'status-new';

        if (statusLower.includes('progress')) {
            className = 'status-in-progress';
        } else if (statusLower.includes('complete')) {
            className = 'status-completed';
        } else if (statusLower.includes('review')) {
            className = 'status-review';
        } else if (statusLower.includes('cancel')) {
            className = 'status-cancelled';
        } else if (statusLower.includes('reject')) {
            className = 'status-rejected';
        } else if (statusLower.includes('approv')) {
            className = 'status-approved';
        }

        return `<span class="status-badge ${className}">${escapeHtml(status)}</span>`;
    }

    /**
     * Render assignee cell
     * @param {string} assignee - Assignee email
     * @returns {string} HTML
     */
    function renderAssigneeCell(assignee) {
        if (!assignee || assignee.trim() === '') {
            return '<span class="unassigned">Unassigned</span>';
        }

        const initial = assignee.charAt(0).toUpperCase();
        const name = assignee.split('@')[0];

        return `
            <div class="assignee-cell">
                <div class="assignee-avatar">${initial}</div>
                <span class="assignee-name">${escapeHtml(name)}</span>
            </div>
        `;
    }

    /**
     * Render deadline cell
     * @param {string} dateStr - Date string
     * @returns {string} HTML
     */
    function renderDeadlineCell(dateStr) {
        if (!dateStr) {
            return '<span style="color: var(--slate-300);">‚Äî</span>';
        }

        try {
            const deadline = new Date(dateStr);
            if (isNaN(deadline.getTime())) return escapeHtml(dateStr);

            const now = new Date();
            const diffHours = (deadline - now) / (1000 * 60 * 60);

            let className = 'deadline-normal';
            if (diffHours < 0 || diffHours <= 48) {
                className = 'deadline-warning';
            }

            const formattedDate = deadline.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });

            return `
                <div class="deadline-cell ${className}">
                    <span class="deadline-icon">üìÖ</span>
                    ${formattedDate}
                </div>
            `;
        } catch (e) {
            return escapeHtml(dateStr);
        }
    }

    /**
     * Generate request ID
     * @param {number} index - Row index
     * @returns {string} Request ID
     */
    function generateRequestId(index) {
        return `REQ-${1000 + index}`;
    }

    /**
     * Format timestamp for display
     * @param {string} timestamp - Timestamp string
     * @returns {string} Formatted timestamp
     */
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'recently';

        try {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 60) {
                return `${diffMins} mins ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hours ago`;
            } else if (diffDays === 1) {
                return '1 day ago';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        } catch (e) {
            return 'recently';
        }
    }

    /**
     * Open details panel
     * @param {Array} row - Row data
     * @param {Array} headers - Column headers
     */
    function openDetails(row, headers) {
        const panel = document.getElementById('detailsPanel');
        const detailsBody = document.getElementById('detailsBody');

        // Determine if this is a Project or Ad Hoc request
        const isProject = currentTab === 'DB_PROJECTS';

        // Store current row index for updates
        const rowIndex = currentData.rows.indexOf(row);
        panel.dataset.rowIndex = rowIndex;
        panel.dataset.isProject = isProject;

        if (isProject) {
            renderProjectDetails(row, headers, panel, detailsBody, rowIndex);
        } else {
            renderAdHocDetails(row, headers, panel, detailsBody, rowIndex);
        }

        // Show panel
        panel.classList.add('open');
    }

    /**
     * Render Ad Hoc Request Details
     */
    function renderAdHocDetails(row, headers, panel, detailsBody, rowIndex) {
        // Get data
        const titleIndex = headers.indexOf('The Request');
        const statusIndex = headers.indexOf('Status');
        const assigneeIndex = headers.indexOf('Assignee');
        const justificationIndex = headers.indexOf('Business Justification');
        const filtersIndex = headers.indexOf('Required Filters / Inclusions');
        const outputIndex = headers.indexOf('Output Format Expectation');
        const requestorIndex = headers.indexOf('Email Address');
        const deliverableIndex = headers.indexOf('Deliverable Evidence');

        const title = row[titleIndex] || 'Untitled Request';
        const status = row[statusIndex] || 'New';
        const assignee = row[assigneeIndex] || '';
        const justification = row[justificationIndex] || 'No justification provided';
        const filters = row[filtersIndex] || 'No filters specified';
        const output = row[outputIndex] || 'Not specified';
        const requestor = row[requestorIndex] || 'Unknown';
        const deliverable = row[deliverableIndex] || '';

        // Update header
        document.getElementById('detailId').textContent = generateRequestId(rowIndex);
        document.getElementById('detailTitle').textContent = title;

        // Render clickable status badge with dropdown
        const statusContainer = document.getElementById('detailStatus');
        statusContainer.innerHTML = `
            <div style="position: relative; display: inline-block;">
                <button 
                    onclick="toggleStatusDropdown(event)" 
                    style="background: none; border: none; padding: 0; cursor: pointer;"
                    aria-label="Change status"
                >
                    ${renderStatusBadge(status)}
                </button>
                <div id="statusDropdown" class="status-dropdown" style="display: none;">
                    <div class="status-dropdown-header">CHANGE STATUS</div>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'New')" data-status="New">
                        <span class="status-dot" style="background: #3b82f6;"></span>
                        New
                        ${status === 'New' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'In Progress')" data-status="In Progress">
                        <span class="status-dot" style="background: #f59e0b;"></span>
                        In Progress
                        ${status === 'In Progress' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'Cancelled')" data-status="Cancelled">
                        <span class="status-dot" style="background: #ef4444;"></span>
                        Cancelled
                        ${status === 'Cancelled' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                </div>
            </div>
        `;

        // Build details body
        const assigneeInitial = assignee ? assignee.charAt(0).toUpperCase() : '?';
        const assigneeName = assignee || 'Unassigned';
        const requestorName = requestor.split('@')[0];

        // Build assignee dropdown options
        const assigneeOptions = teamMembers.map(member => {
            const selected = member === assignee ? 'selected' : '';
            return `<option value="${escapeHtml(member)}" ${selected}>${escapeHtml(member)}</option>`;
        }).join('');
        const unassignedSelected = (!assignee || assignee.trim() === '') ? 'selected' : '';
        const allAssigneeOptions = `<option value="" ${unassignedSelected}>Unassigned</option>${assigneeOptions}`;

        detailsBody.innerHTML = `
            <!-- Owner Section -->
            <div class="details-section">
                <div class="section-header">
                    <span class="section-label">Owner</span>
                    <button class="btn-change" onclick="toggleAssigneeDropdown()">Change</button>
                </div>
                <div class="owner-info" id="ownerDisplay">
                    <div class="owner-avatar">${assigneeInitial}</div>
                    <div>
                        <p class="owner-name">${escapeHtml(assigneeName)}</p>
                        <p class="owner-role">BI Analyst</p>
                    </div>
                </div>
                <div id="ownerEdit" style="display: none;">
                    <select class="assignee-select" id="detailAssigneeSelect" style="width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--slate-300);">
                        ${allAssigneeOptions}
                    </select>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn-complete" onclick="saveAssigneeFromDetails()" style="flex: 1; padding: 0.375rem;">Save</button>
                        <button class="btn-reject" onclick="cancelAssigneeEdit()" style="padding: 0.375rem 0.75rem;">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Request Details -->
            <div style="margin-bottom: 2rem;">
                <div style="margin-bottom: 1rem;">
                    <h3 class="field-label">
                        <span class="field-icon blue">üìÑ</span>
                        Business Justification
                    </h3>
                    <div class="field-content">${escapeHtml(justification)}</div>
                </div>

                <div class="field-grid" style="margin-bottom: 1rem;">
                    <div>
                        <h3 class="field-label">
                            <span class="field-icon purple">üîΩ</span>
                            Filters Needed
                        </h3>
                        <div class="field-content">${escapeHtml(filters)}</div>
                    </div>
                    <div>
                        <h3 class="field-label">
                            <span class="field-icon emerald">üìä</span>
                            Output Format
                        </h3>
                        <div class="field-content">${escapeHtml(output)}</div>
                    </div>
                </div>

                <div>
                    <h3 class="field-label">
                        <span class="field-icon slate">üë§</span>
                        Requestor Contact
                    </h3>
                    <div class="contact-card">
                        <div class="contact-info">
                            <div class="contact-icon">‚úâ</div>
                            <div>
                                <p class="contact-name">${escapeHtml(requestorName)}</p>
                                <p class="contact-email">${escapeHtml(requestor)}</p>
                            </div>
                        </div>
                        <button class="btn-email" onclick="window.location.href='mailto:${escapeHtml(requestor)}'">Send Email</button>
                    </div>
                </div>
            </div>

            <!-- Action Area -->
            <div class="action-section">
                <h3>Deliverable Evidence</h3>
                <input 
                    type="text" 
                    id="deliverableInput"
                    class="action-input" 
                    placeholder="Paste link to dashboard/file..."
                    value="${escapeHtml(deliverable)}"
                    onblur="saveDeliverableEvidence(${rowIndex}, this.value)"
                >
                <div class="action-buttons">
                    <button class="btn-complete" onclick="markAdHocComplete(${rowIndex})">Mark Complete</button>
                </div>
            </div>
        `;
    }

    /**
     * Render Project Request Details (with AI Scoring & Prioritization)
     */
    function renderProjectDetails(row, headers, panel, detailsBody, rowIndex) {
        // Get project-specific data
        const titleIndex = headers.indexOf('Project Title');
        const statusIndex = headers.indexOf('Status');
        const sponsorIndex = headers.indexOf('Executive Sponsor');
        const problemIndex = headers.indexOf('Problem Statement');
        const alignmentIndex = headers.indexOf('Strategic Alignment');
        const impactIndex = headers.indexOf('Impact Quantification');

        // AI Scoring fields
        const aiScoredIndex = headers.indexOf('AI Scored');
        const aiStrategyIndex = headers.indexOf('AI Strategy Score');
        const aiImpactScoreIndex = headers.indexOf('AI Impact Score');
        const aiJustificationIndex = headers.indexOf('AI Justification');

        // PMO fields
        const techEffortIndex = headers.indexOf('Tech Effort');
        const techNotesIndex = headers.indexOf('Tech Notes');
        const finalScoreIndex = headers.indexOf('Final Score');

        const title = row[titleIndex] || 'Untitled Project';
        const status = row[statusIndex] || 'Pending Review';
        const sponsor = row[sponsorIndex] || 'Unknown';
        const problem = row[problemIndex] || 'No problem statement provided';
        const alignment = row[alignmentIndex] || 'Not specified';
        const impact = row[impactIndex] || 'Not specified';

        const aiScored = row[aiScoredIndex] === 'TRUE' || row[aiScoredIndex] === true;
        const aiStrategyScore = parseInt(row[aiStrategyIndex]) || 0;
        const aiImpactScore = parseInt(row[aiImpactScoreIndex]) || 0;
        const aiJustification = row[aiJustificationIndex] || '';

        const techEffort = parseInt(row[techEffortIndex]) || 1;
        const techNotes = row[techNotesIndex] || '';
        const finalScore = parseFloat(row[finalScoreIndex]) || 0;

        // Update header
        document.getElementById('detailId').textContent = `PROJ-${String(rowIndex + 1).padStart(3, '0')}`;
        document.getElementById('detailTitle').textContent = title;
        document.getElementById('detailStatus').innerHTML = renderStatusBadge(status);

        // Render project-specific UI
        detailsBody.innerHTML = `
            <!-- Basic Info Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 0.5rem; border: 1px solid var(--slate-200);">
                    <div style="font-size: 0.75rem; color: var(--slate-400); text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Executive Sponsor</div>
                    <div style="font-weight: 500; color: var(--slate-900);">${escapeHtml(sponsor)}</div>
                </div>
                <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 0.5rem; border: 1px solid var(--slate-200);">
                    <div style="font-size: 0.75rem; color: var(--slate-400); text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Impact</div>
                    <div style="font-weight: 500; color: var(--slate-900); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(impact)}">View Quantification</div>
                </div>
            </div>

            <!-- Problem Statement -->
            <div style="margin-bottom: 2rem;">
                <h3 style="font-weight: 600; color: var(--slate-900); margin-bottom: 0.5rem; font-size: 0.875rem;">Problem Statement</h3>
                <p style="color: var(--slate-600); line-height: 1.6; font-size: 0.875rem;">${escapeHtml(problem)}</p>
            </div>

            <hr style="border: none; border-top: 1px solid var(--slate-100); margin: 2rem 0;">

            <!-- AI Scoring Section -->
            <section id="aiScoringSection">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <h3 style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #4c1d95; font-size: 1rem;">
                        <span style="font-size: 1.25rem;">‚ú®</span>
                        AI Strategic Assessment
                    </h3>
                    ${!aiScored ? `
                        <button 
                            id="aiScoreBtn"
                            onclick="handleAiScore(${rowIndex})"
                            style="display: flex; align-items: center; gap: 0.5rem; background: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background 0.2s;"
                            onmouseover="this.style.background='#4338ca'"
                            onmouseout="this.style.background='#4f46e5'"
                        >
                            <span>ü§ñ</span>
                            <span>Have AI Score This</span>
                        </button>
                    ` : ''}
                </div>

                ${aiScored ? `
                    <div style="background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); border-radius: 0.75rem; border: 1px solid #c7d2fe; padding: 1.25rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: white; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #c7d2fe; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #4f46e5;">${aiStrategyScore}</div>
                                <div style="font-size: 0.75rem; color: #818cf8; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Strategy Score</div>
                            </div>
                            <div style="background: white; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #c7d2fe; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #4f46e5;">${aiImpactScore}</div>
                                <div style="font-size: 0.75rem; color: #818cf8; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Impact Score</div>
                            </div>
                        </div>
                        <div style="background: white; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #c7d2fe; font-size: 0.875rem; color: #4c1d95; font-style: italic;">
                            "${escapeHtml(aiJustification)}"
                        </div>
                    </div>
                ` : `
                    <div style="border: 2px dashed var(--slate-200); border-radius: 0.75rem; padding: 2rem; text-align: center; color: var(--slate-400); font-size: 0.875rem;">
                        Click the button above to generate AI scores and justification.
                    </div>
                `}
            </section>

            <!-- PMO Technical Review -->
            <section style="margin-top: 2rem; ${!aiScored ? 'opacity: 0.5; pointer-events: none; filter: grayscale(1);' : ''}">
                <h3 style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem; font-size: 1rem;">
                    <span style="font-size: 1.25rem;">‚öôÔ∏è</span>
                    PMO Technical Review
                </h3>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--slate-500); text-transform: uppercase; margin-bottom: 0.5rem;">Technical Effort Level (1-3)</label>
                    <div style="display: flex; gap: 1rem;">
                        ${[1, 2, 3].map(val => `
                            <button
                                onclick="handleTechEffortChange(${rowIndex}, ${val})"
                                style="flex: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid ${techEffort === val ? 'var(--slate-800)' : 'var(--slate-200)'}; background: ${techEffort === val ? 'var(--slate-800)' : 'white'}; color: ${techEffort === val ? 'white' : 'var(--slate-600)'}; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                            >
                                Level ${val}
                            </button>
                        `).join('')}
                    </div>
                </div>
                <div>
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--slate-500); text-transform: uppercase; margin-bottom: 0.5rem;">Technical Constraints / Notes</label>
                    <textarea 
                        id="techNotesInput"
                        onblur="handleTechNotesChange(${rowIndex}, this.value)"
                        style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--slate-200); font-size: 0.875rem; font-family: inherit; resize: vertical;"
                        rows="2"
                        placeholder="Enter technical justification..."
                    >${escapeHtml(techNotes)}</textarea>
                </div>
            </section>

            <!-- Final Scoring & Decision -->
            <section style="padding-top: 1.5rem; border-top: 1px solid var(--slate-100); margin-top: 2rem; ${!aiScored ? 'opacity: 0.5; pointer-events: none;' : ''}">
                <div style="background: var(--slate-900); border-radius: 0.75rem; padding: 1.25rem; color: white; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.25rem;">üßÆ</span>
                            <span style="font-weight: 700;">Final Prioritization</span>
                        </div>
                        <div id="finalScoreDisplay" style="font-size: 2rem; font-weight: 700; color: #60a5fa;">${finalScore > 0 ? finalScore.toFixed(1) : '--'}</div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--slate-400); text-align: right; font-family: monospace;">
                        (Strategy + Impact) / Tech Effort
                    </div>
                </div>

                ${currentProjectView === 'pending' ? `
                    <!-- Committee Decision (Pending View Only) -->
                    <div>
                        <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--slate-800); margin-bottom: 0.75rem;">Committee Decision</h3>
                        <div style="display: flex; gap: 0.75rem;">
                            <button 
                                onclick="handleProjectDecision(${rowIndex}, 'Approved')"
                                style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid ${status === 'Approved' ? '#059669' : 'var(--slate-200)'}; background: ${status === 'Approved' ? '#059669' : 'white'}; color: ${status === 'Approved' ? 'white' : '#059669'}; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                onmouseover="if('${status}' !== 'Approved') this.style.background='#ecfdf5'"
                                onmouseout="if('${status}' !== 'Approved') this.style.background='white'"
                            >
                                <span>üëç</span> Approve
                            </button>
                            <button 
                                onclick="handleProjectDecision(${rowIndex}, 'Rejected')"
                                style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid ${status === 'Rejected' ? '#dc2626' : 'var(--slate-200)'}; background: ${status === 'Rejected' ? '#dc2626' : 'white'}; color: ${status === 'Rejected' ? 'white' : '#dc2626'}; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                onmouseover="if('${status}' !== 'Rejected') this.style.background='#fef2f2'"
                                onmouseout="if('${status}' !== 'Rejected') this.style.background='white'"
                            >
                                <span>üëé</span> Reject
                            </button>
                        </div>
                    </div>
                ` : currentProjectView === 'roadmap' ? `
                    <!-- Roadmap Actions -->
                    <div>
                        <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--slate-800); margin-bottom: 0.75rem;">Project Actions</h3>
                        ${status === 'Approved' ? `
                            <button 
                                onclick="handleStartProject(${rowIndex})"
                                style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem; border-radius: 0.5rem; border: none; background: var(--blue-600); color: white; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                onmouseover="this.style.background='var(--blue-700)'"
                                onmouseout="this.style.background='var(--blue-600)'"
                            >
                                <span>‚ñ∂</span> Start Project
                            </button>
                        ` : status === 'In Progress' ? `
                            <button 
                                onclick="handleMarkProjectComplete(${rowIndex})"
                                style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem; border-radius: 0.5rem; border: none; background: #10b981; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                onmouseover="this.style.background='#059669'"
                                onmouseout="this.style.background='#10b981'"
                            >
                                <span>‚úì</span> Mark Complete
                            </button>
                        ` : ''}
                    </div>
                ` : ''}
            </section>
        `;
    }

    /**
     * Handle Start Project (Roadmap View)
     */
    function handleStartProject(rowIndex) {
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');

        // Update local data
        row[statusIndex] = 'In Progress';

        // Update UI
        const statusElement = document.getElementById('detailStatus');
        if (statusElement) {
            statusElement.innerHTML = renderStatusBadge('In Progress');
        }

        // Update database
        updateField(rowIndex, 'Status', 'In Progress', function () {
            // Close panel and reload to refresh the table
            closeDetails();
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Handle Mark Project Complete (Roadmap View)
     */
    function handleMarkProjectComplete(rowIndex) {
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');

        // Update local data
        row[statusIndex] = 'Completed';

        // Update UI
        const statusElement = document.getElementById('detailStatus');
        if (statusElement) {
            statusElement.innerHTML = renderStatusBadge('Completed');
        }

        // Update database
        updateField(rowIndex, 'Status', 'Completed', function () {
            // Close panel and reload to refresh the table
            closeDetails();
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Close details panel
     */
    function closeDetails() {
        const panel = document.getElementById('detailsPanel');
        panel.classList.remove('open');
    }

    /**
     * Toggle assignee dropdown in details panel
     */
    function toggleAssigneeDropdown() {
        const ownerDisplay = document.getElementById('ownerDisplay');
        const ownerEdit = document.getElementById('ownerEdit');

        ownerDisplay.style.display = 'none';
        ownerEdit.style.display = 'block';
    }

    /**
     * Save assignee from details panel
     */
    function saveAssigneeFromDetails() {
        const panel = document.getElementById('detailsPanel');
        const rowIndex = parseInt(panel.dataset.rowIndex);
        const select = document.getElementById('detailAssigneeSelect');
        const newValue = select.value;

        updateField(rowIndex, 'Assignee', newValue, function () {
            // Close the panel and reload data
            closeDetails();
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Cancel assignee edit in details panel
     */
    function cancelAssigneeEdit() {
        const ownerDisplay = document.getElementById('ownerDisplay');
        const ownerEdit = document.getElementById('ownerEdit');

        ownerDisplay.style.display = 'flex';
        ownerEdit.style.display = 'none';
    }

    /**
     * Toggle status dropdown in details panel
     */
    function toggleStatusDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('statusDropdown');
        const isVisible = dropdown.style.display === 'block';

        // Close all other dropdowns first
        document.querySelectorAll('.status-dropdown').forEach(d => d.style.display = 'none');

        // Toggle this dropdown
        dropdown.style.display = isVisible ? 'none' : 'block';

        // Add click listener to close dropdown when clicking outside
        if (!isVisible) {
            setTimeout(() => {
                document.addEventListener('click', closeStatusDropdown);
            }, 0);
        }
    }

    /**
     * Close status dropdown when clicking outside
     */
    function closeStatusDropdown() {
        const dropdown = document.getElementById('statusDropdown');
        if (dropdown) {
            dropdown.style.display = 'none';
        }
        document.removeEventListener('click', closeStatusDropdown);
    }

    /**
     * Change Ad Hoc request status
     */
    function changeAdHocStatus(rowIndex, newStatus) {
        const panel = document.getElementById('detailsPanel');
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');

        // Update local data
        row[statusIndex] = newStatus;

        // Close dropdown
        closeStatusDropdown();

        // Update the status badge in the panel
        const statusContainer = document.getElementById('detailStatus');
        statusContainer.innerHTML = `
            <div style="position: relative; display: inline-block;">
                <button 
                    onclick="toggleStatusDropdown(event)" 
                    style="background: none; border: none; padding: 0; cursor: pointer;"
                    aria-label="Change status"
                >
                    ${renderStatusBadge(newStatus)}
                </button>
                <div id="statusDropdown" class="status-dropdown" style="display: none;">
                    <div class="status-dropdown-header">CHANGE STATUS</div>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'New')" data-status="New">
                        <span class="status-dot" style="background: #3b82f6;"></span>
                        New
                        ${newStatus === 'New' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'In Progress')" data-status="In Progress">
                        <span class="status-dot" style="background: #f59e0b;"></span>
                        In Progress
                        ${newStatus === 'In Progress' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'Cancelled')" data-status="Cancelled">
                        <span class="status-dot" style="background: #ef4444;"></span>
                        Cancelled
                        ${newStatus === 'Cancelled' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                </div>
            </div>
        `;

        // Update the status in the table row
        const tableRow = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (tableRow) {
            const statusCell = tableRow.querySelector('td:nth-child(2)'); // Status is 2nd column in Ad Hoc
            if (statusCell) {
                statusCell.innerHTML = renderStatusBadge(newStatus);
            }
        }

        // Update database in background
        updateField(rowIndex, 'Status', newStatus);
    }

    /**
     * Save deliverable evidence
     */
    function saveDeliverableEvidence(rowIndex, evidence) {
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const deliverableIndex = headers.indexOf('Deliverable Evidence');

        // Update local data
        row[deliverableIndex] = evidence;

        // Update database
        updateField(rowIndex, 'Deliverable Evidence', evidence);
    }

    /**
     * Mark Ad Hoc request as complete
     */
    function markAdHocComplete(rowIndex) {
        const deliverableInput = document.getElementById('deliverableInput');
        const deliverableValue = deliverableInput ? deliverableInput.value.trim() : '';

        // Validate that deliverable evidence is provided
        if (!deliverableValue) {
            alert('Please provide a link to the dashboard or file in the Deliverable Evidence field before marking as complete.');
            deliverableInput.focus();
            return;
        }

        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');
        const deliverableIndex = headers.indexOf('Deliverable Evidence');

        // Update local data
        row[statusIndex] = 'Completed';
        row[deliverableIndex] = deliverableValue;

        // Update the status badge in the panel
        const statusContainer = document.getElementById('detailStatus');
        statusContainer.innerHTML = `
            <div style="position: relative; display: inline-block;">
                <button 
                    onclick="toggleStatusDropdown(event)" 
                    style="background: none; border: none; padding: 0; cursor: pointer;"
                    aria-label="Change status"
                >
                    ${renderStatusBadge('Completed')}
                </button>
                <div id="statusDropdown" class="status-dropdown" style="display: none;">
                    <div class="status-dropdown-header">CHANGE STATUS</div>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'New')" data-status="New">
                        <span class="status-dot" style="background: #3b82f6;"></span>
                        New
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'In Progress')" data-status="In Progress">
                        <span class="status-dot" style="background: #f59e0b;"></span>
                        In Progress
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'Cancelled')" data-status="Cancelled">
                        <span class="status-dot" style="background: #ef4444;"></span>
                        Cancelled
                    </button>
                </div>
            </div>
        `;

        // Update the status in the table row
        const tableRow = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (tableRow) {
            const statusCell = tableRow.querySelector('td:nth-child(2)'); // Status is 2nd column
            if (statusCell) {
                statusCell.innerHTML = renderStatusBadge('Completed');
            }
        }

        // Update database with both status and deliverable evidence
        const updates = {
            'Status': 'Completed',
            'Deliverable Evidence': deliverableValue
        };

        updateMultipleFields(rowIndex, updates, function () {
            // Show success message
            alert('‚úÖ Request marked as complete!');

            // Close the panel
            closeDetails();

            // Reload data to refresh the table
            setTimeout(() => loadData(currentTab), 300);
        });
    }


    /**
     * ========================================
     * PROJECT WORKFLOW HANDLERS
     * ========================================
     */

    /**
     * Handle AI Scoring (Simulates AI API call)
     */
    function handleAiScore(rowIndex) {
        const btn = document.getElementById('aiScoreBtn');
        if (!btn) return;

        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> <span>Analyzing...</span>';

        // Add spin animation
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
        document.head.appendChild(style);

        // Simulate AI API call (1.5 seconds)
        setTimeout(() => {
            // Mock AI scores
            const mockStrategyScore = 10;
            const mockImpactScore = 10;
            const mockJustification = 'This project aligns well with integrated functions and service excellence, showing potential for significant impact on client experience and resource deployment. High strategic value confirmed.';

            // Update the row data
            const updates = {
                'AI Scored': 'TRUE',
                'AI Strategy Score': mockStrategyScore,
                'AI Impact Score': mockImpactScore,
                'AI Justification': mockJustification
            };

            updateMultipleFields(rowIndex, updates, function () {
                // Reload the panel to show new data
                const row = currentData.rows[rowIndex];
                const headers = currentData.headers;
                openDetails(row, headers);
            });
        }, 1500);
    }

    /**
     * Handle Tech Effort Change
     */
    function handleTechEffortChange(rowIndex, newEffort) {
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;

        // Get AI scores
        const aiStrategyIndex = headers.indexOf('AI Strategy Score');
        const aiImpactScoreIndex = headers.indexOf('AI Impact Score');
        const aiStrategyScore = parseInt(row[aiStrategyIndex]) || 0;
        const aiImpactScore = parseInt(row[aiImpactScoreIndex]) || 0;

        // Calculate new final score
        const finalScore = ((aiStrategyScore + aiImpactScore) / newEffort).toFixed(1);

        // Update local data immediately
        const techEffortIndex = headers.indexOf('Tech Effort');
        const finalScoreIndex = headers.indexOf('Final Score');
        row[techEffortIndex] = newEffort;
        row[finalScoreIndex] = finalScore;

        // Update the final score display in the panel (without full re-render)
        const finalScoreDisplay = document.getElementById('finalScoreDisplay');
        if (finalScoreDisplay) {
            finalScoreDisplay.textContent = finalScore;
        }

        // Update the score in the table row
        const tableRow = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (tableRow) {
            const scoreCell = tableRow.querySelector('td:nth-child(5)'); // Score is 5th column
            if (scoreCell) {
                scoreCell.innerHTML = `<span style="font-family: monospace; font-weight: 700; color: var(--slate-700); font-size: 0.875rem;">${finalScore}</span>`;
            }
        }

        // Update database in background
        const updates = {
            'Tech Effort': newEffort,
            'Final Score': finalScore
        };
        updateMultipleFields(rowIndex, updates);
    }

    /**
     * Handle Tech Notes Change
     */
    function handleTechNotesChange(rowIndex, newNotes) {
        updateField(rowIndex, 'Tech Notes', newNotes);
    }

    /**
     * Handle Project Decision (Approve/Reject)
     */
    function handleProjectDecision(rowIndex, decision) {
        // Update local data immediately (optimistic UI)
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');
        row[statusIndex] = decision;

        // Update the status badge in the panel (without full re-render)
        const statusElement = document.getElementById('detailStatus');
        if (statusElement) {
            statusElement.innerHTML = renderStatusBadge(decision);
        }

        // Update the status in the table row (without full table re-render)
        const tableRow = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (tableRow) {
            const statusCell = tableRow.querySelector('td:nth-child(3)'); // Status is 3rd column
            if (statusCell) {
                statusCell.innerHTML = renderStatusBadge(decision);
            }
        }

        // Update database in background
        updateField(rowIndex, 'Status', decision);
    }

    /**
     * Update multiple fields at once
     */
    function updateMultipleFields(rowIndex, updates, callback) {
        const sheetRowIndex = rowIndex + 1; // +1 for header row

        google.script.run
            .withSuccessHandler(function (result) {
                console.log('Multiple fields updated successfully');

                // Update local data
                const headers = currentData.headers;
                Object.keys(updates).forEach(fieldName => {
                    const fieldIndex = headers.indexOf(fieldName);
                    if (fieldIndex !== -1) {
                        currentData.rows[rowIndex][fieldIndex] = updates[fieldName];
                    }
                });

                if (callback) callback(result);
            })
            .withFailureHandler(function (error) {
                console.error('Error updating fields:', error);
                alert('Failed to update fields. Please try again.');
            })
            .updateRow(currentTab, sheetRowIndex, updates);
    }


    /**
     * Render assignee dropdown
     * @param {string} value - Current assignee
     * @param {number} rowIndex - Row index
     * @returns {string} HTML for dropdown
     */
    function renderAssigneeDropdown(value, rowIndex) {
        const options = teamMembers.map(member => {
            const selected = member === value ? 'selected' : '';
            return `<option value="${escapeHtml(member)}" ${selected}>${escapeHtml(member)}</option>`;
        }).join('');

        return `<select class="editable-select" onchange="updateAssignee(${rowIndex}, this.value)">${options}</select>`;
    }

    /**
     * Render status dropdown
     * @param {string} value - Current status
     * @param {number} rowIndex - Row index
     * @param {string} deliverableEvidence - Current deliverable evidence value
     * @returns {string} HTML for dropdown
     */
    function renderStatusDropdown(value, rowIndex, deliverableEvidence) {
        const statuses = ['New', 'In Progress', 'Completed'];
        const statusClass = getStatusSelectClass(value);

        const options = statuses.map(status => {
            const selected = status === value ? 'selected' : '';
            // Disable "Completed" if no deliverable evidence
            const disabled = (status === 'Completed' && (!deliverableEvidence || deliverableEvidence.trim() === '')) ? 'disabled' : '';
            return `<option value="${status}" ${selected} ${disabled}>${status}</option>`;
        }).join('');

        return `<select class="editable-select ${statusClass}" 
                        onchange="updateStatus(${rowIndex}, this.value)" 
                        data-row-index="${rowIndex}">${options}</select>`;
    }

    /**
     * Render deliverable evidence input
     * @param {string} value - Current value
     * @param {number} rowIndex - Row index
     * @returns {string} HTML for input
     */
    function renderDeliverableInput(value, rowIndex) {
        const displayValue = value || '';
        return `<input type="text" 
                       class="editable-input" 
                       value="${escapeHtml(displayValue)}" 
                       placeholder="Paste link to deliverable..."
                       onblur="updateDeliverable(${rowIndex}, this.value)"
                       data-row-index="${rowIndex}">`;
    }

    /**
     * Format deadline with urgency highlighting
     * @param {string} dateStr - Date string
     * @returns {string} Formatted HTML
     */
    function formatDeadline(dateStr) {
        if (!dateStr) return '<span style="color: var(--gray-light);">‚Äî</span>';

        try {
            const deadline = new Date(dateStr);
            if (isNaN(deadline.getTime())) return escapeHtml(dateStr);

            const now = new Date();
            const diffMs = deadline - now;
            const diffHours = diffMs / (1000 * 60 * 60);
            const diffDays = diffHours / 24;

            let className = 'deadline-normal';
            let urgencyLabel = '';

            if (diffHours < 0) {
                className = 'deadline-critical';
                urgencyLabel = ' ‚ö†Ô∏è OVERDUE';
            } else if (diffHours <= 48) {
                className = 'deadline-critical';
                urgencyLabel = ' üî• 48h';
            } else if (diffDays <= 7) {
                className = 'deadline-warning';
                urgencyLabel = ' ‚ö° 1 week';
            }

            const formattedDate = deadline.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: deadline.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });

            return `<span class="${className}">${formattedDate}${urgencyLabel}</span>`;
        } catch (e) {
            return escapeHtml(dateStr);
        }
    }

    /**
     * Get status select class based on value
     * @param {string} status - Status value
     * @returns {string} CSS class
     */
    function getStatusSelectClass(status) {
        const statusLower = String(status).toLowerCase();
        if (statusLower.includes('new')) return 'status-select-new';
        if (statusLower.includes('progress')) return 'status-select-in-progress';
        if (statusLower.includes('complete')) return 'status-select-completed';
        return '';
    }

    /**
     * Update assignee
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New assignee value
     */
    function updateAssignee(rowIndex, newValue) {
        updateField(rowIndex, 'Assignee', newValue);
    }

    /**
     * Update assignee from table dropdown
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New assignee value
     */
    function updateAssigneeFromTable(rowIndex, newValue) {
        updateField(rowIndex, 'Assignee', newValue, function () {
            // Reload data to refresh the table
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Update status with validation
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New status value
     */
    function updateStatus(rowIndex, newValue) {
        const deliverableIndex = currentData.headers.indexOf('Deliverable Evidence');
        const deliverableValue = currentData.rows[rowIndex][deliverableIndex];

        // Validate on client side
        if (newValue === 'Completed' && (!deliverableValue || deliverableValue.trim() === '')) {
            showError('Cannot mark as Completed without Deliverable Evidence. Please provide a link to the final output.');

            // Reset dropdown to previous value
            const statusIndex = currentData.headers.indexOf('Status');
            const previousValue = currentData.rows[rowIndex][statusIndex];
            const select = document.querySelector(`select[data-row-index="${rowIndex}"]`);
            if (select) {
                select.value = previousValue;
            }
            return;
        }

        updateField(rowIndex, 'Status', newValue, function () {
            // Update the dropdown class after successful update
            const select = document.querySelector(`select[data-row-index="${rowIndex}"]`);
            if (select) {
                select.className = 'editable-select ' + getStatusSelectClass(newValue);
            }

            // If marked as completed, refresh to remove from "My Active Tasks" view
            if (newValue === 'Completed' && currentView === 'myTasks') {
                setTimeout(() => loadData(currentTab), 500);
            }
        });
    }

    /**
     * Update deliverable evidence
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New deliverable value
     */
    function updateDeliverable(rowIndex, newValue) {
        updateField(rowIndex, 'Deliverable Evidence', newValue, function () {
            // Re-enable "Completed" option in status dropdown if deliverable is now provided
            if (newValue && newValue.trim() !== '') {
                const statusSelect = document.querySelector(`select.editable-select[data-row-index="${rowIndex}"]`);
                if (statusSelect) {
                    const completedOption = statusSelect.querySelector('option[value="Completed"]');
                    if (completedOption) {
                        completedOption.disabled = false;
                    }
                }
            }
        });
    }

    /**
     * Generic field update function
     * @param {number} rowIndex - Row index
     * @param {string} columnName - Column name
     * @param {string} newValue - New value
     * @param {Function} callback - Optional callback after successful update
     */
    function updateField(rowIndex, columnName, newValue, callback) {
        const updates = {};
        updates[columnName] = newValue;

        // Show loading indicator (optional)
        console.log(`Updating ${columnName} to "${newValue}" for row ${rowIndex}`);

        google.script.run
            .withSuccessHandler(function (success) {
                if (success) {
                    // Update local data
                    const colIndex = currentData.headers.indexOf(columnName);
                    if (colIndex !== -1) {
                        currentData.rows[rowIndex][colIndex] = newValue;
                    }

                    // Execute callback if provided
                    if (callback) callback();

                    console.log(`Successfully updated ${columnName}`);
                } else {
                    showError(`Failed to update ${columnName}`);
                }
            })
            .withFailureHandler(function (error) {
                showError(`Error updating ${columnName}: ${error.message}`);
                console.error('Update error:', error);
            })
            .updateRow(currentTab, rowIndex + 1, updates);
    }

    /**
     * Format cell content based on column type
     * @param {*} value - Cell value
     * @param {string} header - Column header
     * @returns {string} Formatted HTML
     */
    function formatCell(value, header) {
        // Handle empty values
        if (value === null || value === undefined || value === '') {
            return '<span style="color: var(--gray-light);">‚Äî</span>';
        }

        // Status column (for non-editable views)
        if (header === 'Status') {
            const statusClass = getStatusClass(value);
            return `<span class="status-badge ${statusClass}">${value}</span>`;
        }

        // Priority column
        if (header === 'Priority') {
            const priorityClass = getPriorityClass(value);
            return `<span class="${priorityClass}">${value}</span>`;
        }

        // Email columns
        if (header.includes('Email')) {
            return `<a href="mailto:${value}" style="color: var(--primary); text-decoration: none;">${value}</a>`;
        }

        // Date columns (except Hard Deadline which is handled separately)
        if ((header.includes('Date') || header.includes('Timestamp') || header.includes('Modified')) && header !== 'Hard Deadline') {
            return formatDate(value);
        }

        // Default
        return escapeHtml(String(value));
    }

    /**
     * Get status badge class
     * @param {string} status - Status value
     * @returns {string} CSS class name
     */
    function getStatusClass(status) {
        const statusLower = String(status).toLowerCase();

        if (statusLower.includes('new')) return 'status-new';
        if (statusLower.includes('progress') || statusLower.includes('active')) return 'status-in-progress';
        if (statusLower.includes('complete') || statusLower.includes('done')) return 'status-completed';
        if (statusLower.includes('hold') || statusLower.includes('pending')) return 'status-on-hold';

        return 'status-new';
    }

    /**
     * Get priority class
     * @param {string} priority - Priority value
     * @returns {string} CSS class name
     */
    function getPriorityClass(priority) {
        const priorityLower = String(priority).toLowerCase();

        if (priorityLower.includes('high') || priorityLower.includes('urgent')) return 'priority-high';
        if (priorityLower.includes('medium') || priorityLower.includes('normal')) return 'priority-medium';
        if (priorityLower.includes('low')) return 'priority-low';

        return '';
    }

    /**
     * Format date string
     * @param {string} dateStr - Date string
     * @returns {string} Formatted date
     */
    function formatDate(dateStr) {
        if (!dateStr) return '‚Äî';

        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            // Show relative time for recent dates
            if (diffDays === 0) {
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
                }
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            }

            // Format as date
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        } catch (e) {
            return dateStr;
        }
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Show loading state
     */
    function showLoading() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('dataGridSection').style.display = 'none';
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
    }

    /**
     * Hide loading state
     */
    function hideLoading() {
        document.getElementById('loadingState').classList.add('hidden');
    }

    /**
     * Show empty state
     */
    function showEmptyState() {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('dataGridSection').style.display = 'none';
        document.getElementById('stat-total').textContent = '0';
        document.getElementById('stat-urgent').textContent = '0';
    }

    /**
     * Show error message
     * @param {string} message - Error message
     */
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = `‚ö†Ô∏è ${message}`;
        errorDiv.classList.remove('hidden');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    }

    /**
     * Refresh current view
     */
    function refreshData() {
        loadData(currentTab);
    }

    // Auto-refresh every 5 minutes
    setInterval(refreshData, 5 * 60 * 1000);
</script>