<script>
    /**
     * ========================================
     * PMO INTAKE DASHBOARD - TASK MANAGEMENT WORKSPACE
     * ========================================
     */

    // Global state
    let currentTab = 'DB_ADHOCS';
    let currentView = 'myTasks'; // 'myTasks' or 'allRequests'
    let currentData = null;
    let teamMembers = [];
    let userEmail = '';

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function () {
        initializeDashboard();
    });

    /**
     * Initialize the dashboard
     */
    function initializeDashboard() {
        // Set user email from server - get it from the server instead
        google.script.run
            .withSuccessHandler(function (email) {
                userEmail = email;

                // Extract name from email (part before @)
                const userName = email.split('@')[0];
                // Capitalize first letter of each word (e.g., "ipalacio" -> "Ipalacio")
                const displayName = userName.charAt(0).toUpperCase() + userName.slice(1);

                document.getElementById('userEmail').textContent = email;
                document.querySelector('.user-name').textContent = displayName;

                // Set user avatar (first letter of name)
                const firstLetter = displayName.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;

                // Now load team members and data
                loadTeamMembersAndData();
            })
            .withFailureHandler(function (error) {
                console.error('Error getting user email:', error);
                userEmail = 'unknown@ucsd.edu';
                document.getElementById('userEmail').textContent = 'Error loading email';
                document.querySelector('.user-name').textContent = 'Unknown User';
                // Still try to load data
                loadTeamMembersAndData();
            })
            .getUserEmail();
    }

    /**
     * Load team members and initial data
     * Called after user email is retrieved
     */
    function loadTeamMembersAndData() {
        // Load team members
        google.script.run
            .withSuccessHandler(function (members) {
                teamMembers = members;
                // Load initial data after team members are loaded
                loadData(currentTab);
            })
            .withFailureHandler(function (error) {
                console.error('Error loading team members:', error);
                // Load data anyway with empty team list
                loadData(currentTab);
            })
            .getTeamMembers();
    }

    /**
     * Switch between tabs
     * @param {string} tabName - Name of the tab to switch to
     */
    function switchTab(tabName) {
        // Update active state on sidebar nav buttons
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.classList.remove('active');
        });

        const activeButton = tabName === 'DB_ADHOCS' ?
            document.getElementById('nav-adhoc') :
            document.getElementById('nav-projects');

        activeButton.classList.add('active');

        // Update current tab
        currentTab = tabName;

        // Update top bar title
        const title = tabName === 'DB_ADHOCS' ? 'Ad Hoc Requests Queue' : 'Project Portfolio';
        document.getElementById('topBarTitle').textContent = title;

        // Show/hide filters bar (only for Ad Hoc Requests)
        const filtersBar = document.querySelector('.filters-bar');
        if (tabName === 'DB_ADHOCS') {
            filtersBar.style.display = 'flex';
        } else {
            filtersBar.style.display = 'none';
        }

        // Load data
        loadData(tabName);
    }

    /**
     * Switch between views (My Active Tasks vs All Requests)
     * @param {string} viewName - Name of the view
     */
    function switchView(viewName) {
        // Update active state on filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        const activeButton = viewName === 'myTasks' ?
            document.getElementById('filter-my') :
            document.getElementById('filter-all');

        activeButton.classList.add('active');

        // Update current view
        currentView = viewName;

        // Re-render table with filtered data
        if (currentData) {
            renderTable(currentData);
        }
    }

    /**
     * Load data from the server
     * @param {string} tabName - Name of the tab to load data from
     */
    function loadData(tabName) {
        // Show loading state
        showLoading();

        // Call server-side function
        google.script.run
            .withSuccessHandler(onDataLoaded)
            .withFailureHandler(onDataError)
            .getData(tabName);
    }

    /**
     * Handle successful data load
     * @param {Object} data - Data object with headers and rows
     */
    function onDataLoaded(data) {
        currentData = data;

        // Hide loading state
        hideLoading();

        // Check if data is empty
        if (!data.rows || data.rows.length === 0) {
            showEmptyState();
            return;
        }

        // Render table
        renderTable(data);
    }

    /**
     * Handle data load error
     * @param {Error} error - Error object
     */
    function onDataError(error) {
        hideLoading();
        showError(error.message || 'Failed to load data. Please try again.');
        console.error('Error loading data:', error);
    }

    /**
     * Filter data based on current view
     * @param {Object} data - Original data
     * @returns {Object} Filtered data
     */
    function filterData(data) {
        // Only filter for Ad Hoc Requests in "My Active Tasks" view
        if (currentTab !== 'DB_ADHOCS' || currentView !== 'myTasks') {
            console.log('Not filtering - currentTab:', currentTab, 'currentView:', currentView);
            return data;
        }

        console.log('Filter Debug - Current user email:', userEmail);

        const assigneeIndex = data.headers.indexOf('Assignee');
        const statusIndex = data.headers.indexOf('Status');

        if (assigneeIndex === -1 || statusIndex === -1) {
            console.warn('Missing required columns - Assignee index:', assigneeIndex, 'Status index:', statusIndex);
            return data;
        }

        // Filter rows where Assignee matches current user AND Status is not "Completed"
        const filteredRows = data.rows.filter(row => {
            const assignee = row[assigneeIndex];
            const status = row[statusIndex];

            // Match assignee (case-insensitive, partial match on email)
            const isMyTask = assignee && assignee.toLowerCase().includes(userEmail.toLowerCase());
            const isNotCompleted = status !== 'Completed';

            // Debug log for each row
            if (assignee) {
                console.log(`Row - Assignee: "${assignee}", Status: "${status}", Match: ${isMyTask}, NotCompleted: ${isNotCompleted}`);
            }

            return isMyTask && isNotCompleted;
        });

        console.log(`âœ… Filtered ${filteredRows.length} rows from ${data.rows.length} total rows`);

        return {
            headers: data.headers,
            rows: filteredRows
        };
    }

    /**
     * Render the data table
     * @param {Object} data - Data object with headers and rows
     */
    function renderTable(data) {
        const tableBody = document.getElementById('tableBody');
        const dataGridSection = document.getElementById('dataGridSection');

        // Filter data based on current view
        const filteredData = filterData(data);

        // Calculate stats
        calculateStats(filteredData);

        // Check if filtered data is empty
        if (filteredData.rows.length === 0) {
            showEmptyState();
            return;
        }

        // Clear existing content
        tableBody.innerHTML = '';

        // Get column indices
        const titleIndex = data.headers.indexOf('The Request');
        const statusIndex = data.headers.indexOf('Status');
        const assigneeIndex = data.headers.indexOf('Assignee');
        const deadlineIndex = data.headers.indexOf('Hard Deadline');
        const idIndex = data.headers.indexOf('Timestamp'); // Use timestamp as ID for now
        const requestorIndex = data.headers.indexOf('Email Address');

        // Create data rows
        filteredData.rows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.dataset.rowIndex = rowIndex;
            tr.onclick = () => openDetails(row, data.headers);

            // Request Column (Title + Metadata)
            const tdRequest = document.createElement('td');
            const title = row[titleIndex] || 'Untitled Request';
            const requestor = row[requestorIndex] || 'Unknown';
            const timestamp = formatTimestamp(row[idIndex]);
            const requestId = generateRequestId(rowIndex);

            tdRequest.innerHTML = `
                <div class="request-title">${escapeHtml(title)}</div>
                <div class="request-meta">
                    ${requestId} â€¢ ${escapeHtml(requestor.split('@')[0])} â€¢ <span>${timestamp}</span>
                </div>
            `;
            tr.appendChild(tdRequest);

            // Status Column
            const tdStatus = document.createElement('td');
            const status = row[statusIndex] || 'New';
            tdStatus.innerHTML = renderStatusBadge(status);
            tr.appendChild(tdStatus);

            // Assignee Column
            const tdAssignee = document.createElement('td');
            const assignee = row[assigneeIndex];
            tdAssignee.innerHTML = renderAssigneeCell(assignee, rowIndex);
            tr.appendChild(tdAssignee);

            // Deadline Column
            const tdDeadline = document.createElement('td');
            const deadline = row[deadlineIndex];
            tdDeadline.innerHTML = renderDeadlineCell(deadline);
            tr.appendChild(tdDeadline);

            // Action Column (Chevron)
            const tdAction = document.createElement('td');
            tdAction.style.textAlign = 'right';
            tdAction.innerHTML = '<span class="chevron-icon">â€º</span>';
            tr.appendChild(tdAction);

            tableBody.appendChild(tr);
        });

        // Show table
        dataGridSection.style.display = 'block';
        document.getElementById('emptyState').classList.add('hidden');
    }

    /**
     * Calculate and update stats
     * @param {Object} data - Filtered data
     */
    function calculateStats(data) {
        const total = data.rows.length;

        // Calculate urgent (due < 48 hours)
        const deadlineIndex = currentData.headers.indexOf('Hard Deadline');
        const now = new Date();
        let urgent = 0;

        data.rows.forEach(row => {
            const deadlineStr = row[deadlineIndex];
            if (deadlineStr) {
                try {
                    const deadline = new Date(deadlineStr);
                    const diffHours = (deadline - now) / (1000 * 60 * 60);
                    if (diffHours > 0 && diffHours <= 48) {
                        urgent++;
                    }
                } catch (e) {
                    // Ignore invalid dates
                }
            }
        });

        // Calculate new count for badge
        const statusIndex = currentData.headers.indexOf('Status');
        const newCount = currentData.rows.filter(row => row[statusIndex] === 'New').length;

        // Update UI
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-urgent').textContent = urgent;
        document.getElementById('badge-new').textContent = newCount;
    }

    /**
     * Render priority icon
     * @param {string} priority - Priority value
     * @returns {string} HTML
     */
    function renderPriorityIcon(priority) {
        const priorityLower = String(priority).toLowerCase();

        if (priorityLower.includes('high')) {
            return '<div class="priority-icon priority-high">âš </div>';
        } else if (priorityLower.includes('medium')) {
            return '<div class="priority-icon"><div class="priority-medium"></div></div>';
        } else {
            return '<div class="priority-icon"><div class="priority-low"></div></div>';
        }
    }

    /**
     * Render status badge
     * @param {string} status - Status value
     * @returns {string} HTML
     */
    function renderStatusBadge(status) {
        const statusLower = String(status).toLowerCase();
        let className = 'status-new';

        if (statusLower.includes('progress')) {
            className = 'status-in-progress';
        } else if (statusLower.includes('complete')) {
            className = 'status-completed';
        } else if (statusLower.includes('review')) {
            className = 'status-review';
        }

        return `<span class="status-badge ${className}">${escapeHtml(status)}</span>`;
    }

    /**
     * Render assignee cell
     * @param {string} assignee - Assignee email
     * @param {number} rowIndex - Row index for updating
     * @returns {string} HTML
     */
    function renderAssigneeCell(assignee, rowIndex) {
        const options = teamMembers.map(member => {
            const selected = member === assignee ? 'selected' : '';
            return `<option value="${escapeHtml(member)}" ${selected}>${escapeHtml(member)}</option>`;
        }).join('');

        // Add "Unassigned" option at the beginning
        const unassignedSelected = (!assignee || assignee.trim() === '') ? 'selected' : '';
        const allOptions = `<option value="" ${unassignedSelected}>Unassigned</option>${options}`;

        return `
            <select class="assignee-select" 
                    onchange="updateAssigneeFromTable(${rowIndex}, this.value)" 
                    onclick="event.stopPropagation()">
                ${allOptions}
            </select>
        `;
    }

    /**
     * Render deadline cell
     * @param {string} dateStr - Date string
     * @returns {string} HTML
     */
    function renderDeadlineCell(dateStr) {
        if (!dateStr) {
            return '<span style="color: var(--slate-300);">â€”</span>';
        }

        try {
            const deadline = new Date(dateStr);
            if (isNaN(deadline.getTime())) return escapeHtml(dateStr);

            const now = new Date();
            const diffHours = (deadline - now) / (1000 * 60 * 60);

            let className = 'deadline-normal';
            if (diffHours < 0 || diffHours <= 48) {
                className = 'deadline-warning';
            }

            const formattedDate = deadline.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });

            return `
                <div class="deadline-cell ${className}">
                    <span class="deadline-icon">ðŸ“…</span>
                    ${formattedDate}
                </div>
            `;
        } catch (e) {
            return escapeHtml(dateStr);
        }
    }

    /**
     * Generate request ID
     * @param {number} index - Row index
     * @returns {string} Request ID
     */
    function generateRequestId(index) {
        return `REQ-${1000 + index}`;
    }

    /**
     * Format timestamp for display
     * @param {string} timestamp - Timestamp string
     * @returns {string} Formatted timestamp
     */
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'recently';

        try {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 60) {
                return `${diffMins} mins ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hours ago`;
            } else if (diffDays === 1) {
                return '1 day ago';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        } catch (e) {
            return 'recently';
        }
    }

    /**
     * Open details panel
     * @param {Array} row - Row data
     * @param {Array} headers - Column headers
     */
    function openDetails(row, headers) {
        const panel = document.getElementById('detailsPanel');
        const detailsBody = document.getElementById('detailsBody');

        // Get data
        const titleIndex = headers.indexOf('The Request');
        const statusIndex = headers.indexOf('Status');
        const assigneeIndex = headers.indexOf('Assignee');
        const justificationIndex = headers.indexOf('Business Justification');
        const filtersIndex = headers.indexOf('Required Filters / Inclusions');
        const outputIndex = headers.indexOf('Output Format Expectation');
        const requestorIndex = headers.indexOf('Email Address');
        const deliverableIndex = headers.indexOf('Deliverable Evidence');

        const title = row[titleIndex] || 'Untitled Request';
        const status = row[statusIndex] || 'New';
        const assignee = row[assigneeIndex] || '';
        const justification = row[justificationIndex] || 'No justification provided';
        const filters = row[filtersIndex] || 'No filters specified';
        const output = row[outputIndex] || 'Not specified';
        const requestor = row[requestorIndex] || 'Unknown';
        const deliverable = row[deliverableIndex] || '';

        // Store current row index for updates
        const rowIndex = currentData.rows.indexOf(row);
        panel.dataset.rowIndex = rowIndex;

        // Update header with correct request ID
        document.getElementById('detailId').textContent = generateRequestId(rowIndex);
        document.getElementById('detailTitle').textContent = title;
        document.getElementById('detailStatus').innerHTML = renderStatusBadge(status);

        // Build details body
        const assigneeInitial = assignee ? assignee.charAt(0).toUpperCase() : '?';
        const assigneeName = assignee || 'Unassigned';
        const requestorName = requestor.split('@')[0];

        // Build assignee dropdown options
        const assigneeOptions = teamMembers.map(member => {
            const selected = member === assignee ? 'selected' : '';
            return `<option value="${escapeHtml(member)}" ${selected}>${escapeHtml(member)}</option>`;
        }).join('');
        const unassignedSelected = (!assignee || assignee.trim() === '') ? 'selected' : '';
        const allAssigneeOptions = `<option value="" ${unassignedSelected}>Unassigned</option>${assigneeOptions}`;

        detailsBody.innerHTML = `
            <!-- Owner Section -->
            <div class="details-section">
                <div class="section-header">
                    <span class="section-label">Owner</span>
                    <button class="btn-change" onclick="toggleAssigneeDropdown()">Change</button>
                </div>
                <div class="owner-info" id="ownerDisplay">
                    <div class="owner-avatar">${assigneeInitial}</div>
                    <div>
                        <p class="owner-name">${escapeHtml(assigneeName)}</p>
                        <p class="owner-role">BI Analyst</p>
                    </div>
                </div>
                <div id="ownerEdit" style="display: none;">
                    <select class="assignee-select" id="detailAssigneeSelect" style="width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--slate-300);">
                        ${allAssigneeOptions}
                    </select>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn-complete" onclick="saveAssigneeFromDetails()" style="flex: 1; padding: 0.375rem;">Save</button>
                        <button class="btn-reject" onclick="cancelAssigneeEdit()" style="padding: 0.375rem 0.75rem;">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Request Details -->
            <div style="margin-bottom: 2rem;">
                <div style="margin-bottom: 1rem;">
                    <h3 class="field-label">
                        <span class="field-icon blue">ðŸ“„</span>
                        Business Justification
                    </h3>
                    <div class="field-content">${escapeHtml(justification)}</div>
                </div>

                <div class="field-grid" style="margin-bottom: 1rem;">
                    <div>
                        <h3 class="field-label">
                            <span class="field-icon purple">ðŸ”½</span>
                            Filters Needed
                        </h3>
                        <div class="field-content">${escapeHtml(filters)}</div>
                    </div>
                    <div>
                        <h3 class="field-label">
                            <span class="field-icon emerald">ðŸ“Š</span>
                            Output Format
                        </h3>
                        <div class="field-content">${escapeHtml(output)}</div>
                    </div>
                </div>

                <div>
                    <h3 class="field-label">
                        <span class="field-icon slate">ðŸ‘¤</span>
                        Requestor Contact
                    </h3>
                    <div class="contact-card">
                        <div class="contact-info">
                            <div class="contact-icon">âœ‰</div>
                            <div>
                                <p class="contact-name">${escapeHtml(requestorName)}</p>
                                <p class="contact-email">${escapeHtml(requestor)}</p>
                            </div>
                        </div>
                        <button class="btn-email" onclick="window.location.href='mailto:${escapeHtml(requestor)}'">Send Email</button>
                    </div>
                </div>
            </div>

            <!-- Action Area -->
            <div class="action-section">
                <h3>Deliverable Evidence</h3>
                <input 
                    type="text" 
                    class="action-input" 
                    placeholder="Paste link to dashboard/file..."
                    value="${escapeHtml(deliverable)}"
                >
                <div class="action-buttons">
                    <button class="btn-complete">Mark Complete</button>
                </div>
            </div>
        `;

        // Open panel
        panel.classList.add('open');
    }

    /**
     * Close details panel
     */
    function closeDetails() {
        const panel = document.getElementById('detailsPanel');
        panel.classList.remove('open');
    }

    /**
     * Toggle assignee dropdown in details panel
     */
    function toggleAssigneeDropdown() {
        const ownerDisplay = document.getElementById('ownerDisplay');
        const ownerEdit = document.getElementById('ownerEdit');

        ownerDisplay.style.display = 'none';
        ownerEdit.style.display = 'block';
    }

    /**
     * Save assignee from details panel
     */
    function saveAssigneeFromDetails() {
        const panel = document.getElementById('detailsPanel');
        const rowIndex = parseInt(panel.dataset.rowIndex);
        const select = document.getElementById('detailAssigneeSelect');
        const newValue = select.value;

        updateField(rowIndex, 'Assignee', newValue, function () {
            // Close the panel and reload data
            closeDetails();
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Cancel assignee edit in details panel
     */
    function cancelAssigneeEdit() {
        const ownerDisplay = document.getElementById('ownerDisplay');
        const ownerEdit = document.getElementById('ownerEdit');

        ownerDisplay.style.display = 'flex';
        ownerEdit.style.display = 'none';
    }

    /**
     * Render assignee dropdown
     * @param {string} value - Current assignee
     * @param {number} rowIndex - Row index
     * @returns {string} HTML for dropdown
     */
    function renderAssigneeDropdown(value, rowIndex) {
        const options = teamMembers.map(member => {
            const selected = member === value ? 'selected' : '';
            return `<option value="${escapeHtml(member)}" ${selected}>${escapeHtml(member)}</option>`;
        }).join('');

        return `<select class="editable-select" onchange="updateAssignee(${rowIndex}, this.value)">${options}</select>`;
    }

    /**
     * Render status dropdown
     * @param {string} value - Current status
     * @param {number} rowIndex - Row index
     * @param {string} deliverableEvidence - Current deliverable evidence value
     * @returns {string} HTML for dropdown
     */
    function renderStatusDropdown(value, rowIndex, deliverableEvidence) {
        const statuses = ['New', 'In Progress', 'Completed'];
        const statusClass = getStatusSelectClass(value);

        const options = statuses.map(status => {
            const selected = status === value ? 'selected' : '';
            // Disable "Completed" if no deliverable evidence
            const disabled = (status === 'Completed' && (!deliverableEvidence || deliverableEvidence.trim() === '')) ? 'disabled' : '';
            return `<option value="${status}" ${selected} ${disabled}>${status}</option>`;
        }).join('');

        return `<select class="editable-select ${statusClass}" 
                        onchange="updateStatus(${rowIndex}, this.value)" 
                        data-row-index="${rowIndex}">${options}</select>`;
    }

    /**
     * Render deliverable evidence input
     * @param {string} value - Current value
     * @param {number} rowIndex - Row index
     * @returns {string} HTML for input
     */
    function renderDeliverableInput(value, rowIndex) {
        const displayValue = value || '';
        return `<input type="text" 
                       class="editable-input" 
                       value="${escapeHtml(displayValue)}" 
                       placeholder="Paste link to deliverable..."
                       onblur="updateDeliverable(${rowIndex}, this.value)"
                       data-row-index="${rowIndex}">`;
    }

    /**
     * Format deadline with urgency highlighting
     * @param {string} dateStr - Date string
     * @returns {string} Formatted HTML
     */
    function formatDeadline(dateStr) {
        if (!dateStr) return '<span style="color: var(--gray-light);">â€”</span>';

        try {
            const deadline = new Date(dateStr);
            if (isNaN(deadline.getTime())) return escapeHtml(dateStr);

            const now = new Date();
            const diffMs = deadline - now;
            const diffHours = diffMs / (1000 * 60 * 60);
            const diffDays = diffHours / 24;

            let className = 'deadline-normal';
            let urgencyLabel = '';

            if (diffHours < 0) {
                className = 'deadline-critical';
                urgencyLabel = ' âš ï¸ OVERDUE';
            } else if (diffHours <= 48) {
                className = 'deadline-critical';
                urgencyLabel = ' ðŸ”¥ 48h';
            } else if (diffDays <= 7) {
                className = 'deadline-warning';
                urgencyLabel = ' âš¡ 1 week';
            }

            const formattedDate = deadline.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: deadline.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });

            return `<span class="${className}">${formattedDate}${urgencyLabel}</span>`;
        } catch (e) {
            return escapeHtml(dateStr);
        }
    }

    /**
     * Get status select class based on value
     * @param {string} status - Status value
     * @returns {string} CSS class
     */
    function getStatusSelectClass(status) {
        const statusLower = String(status).toLowerCase();
        if (statusLower.includes('new')) return 'status-select-new';
        if (statusLower.includes('progress')) return 'status-select-in-progress';
        if (statusLower.includes('complete')) return 'status-select-completed';
        return '';
    }

    /**
     * Update assignee
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New assignee value
     */
    function updateAssignee(rowIndex, newValue) {
        updateField(rowIndex, 'Assignee', newValue);
    }

    /**
     * Update assignee from table dropdown
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New assignee value
     */
    function updateAssigneeFromTable(rowIndex, newValue) {
        updateField(rowIndex, 'Assignee', newValue, function () {
            // Reload data to refresh the table
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Update status with validation
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New status value
     */
    function updateStatus(rowIndex, newValue) {
        const deliverableIndex = currentData.headers.indexOf('Deliverable Evidence');
        const deliverableValue = currentData.rows[rowIndex][deliverableIndex];

        // Validate on client side
        if (newValue === 'Completed' && (!deliverableValue || deliverableValue.trim() === '')) {
            showError('Cannot mark as Completed without Deliverable Evidence. Please provide a link to the final output.');

            // Reset dropdown to previous value
            const statusIndex = currentData.headers.indexOf('Status');
            const previousValue = currentData.rows[rowIndex][statusIndex];
            const select = document.querySelector(`select[data-row-index="${rowIndex}"]`);
            if (select) {
                select.value = previousValue;
            }
            return;
        }

        updateField(rowIndex, 'Status', newValue, function () {
            // Update the dropdown class after successful update
            const select = document.querySelector(`select[data-row-index="${rowIndex}"]`);
            if (select) {
                select.className = 'editable-select ' + getStatusSelectClass(newValue);
            }

            // If marked as completed, refresh to remove from "My Active Tasks" view
            if (newValue === 'Completed' && currentView === 'myTasks') {
                setTimeout(() => loadData(currentTab), 500);
            }
        });
    }

    /**
     * Update deliverable evidence
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New deliverable value
     */
    function updateDeliverable(rowIndex, newValue) {
        updateField(rowIndex, 'Deliverable Evidence', newValue, function () {
            // Re-enable "Completed" option in status dropdown if deliverable is now provided
            if (newValue && newValue.trim() !== '') {
                const statusSelect = document.querySelector(`select.editable-select[data-row-index="${rowIndex}"]`);
                if (statusSelect) {
                    const completedOption = statusSelect.querySelector('option[value="Completed"]');
                    if (completedOption) {
                        completedOption.disabled = false;
                    }
                }
            }
        });
    }

    /**
     * Generic field update function
     * @param {number} rowIndex - Row index
     * @param {string} columnName - Column name
     * @param {string} newValue - New value
     * @param {Function} callback - Optional callback after successful update
     */
    function updateField(rowIndex, columnName, newValue, callback) {
        const updates = {};
        updates[columnName] = newValue;

        // Show loading indicator (optional)
        console.log(`Updating ${columnName} to "${newValue}" for row ${rowIndex}`);

        google.script.run
            .withSuccessHandler(function (success) {
                if (success) {
                    // Update local data
                    const colIndex = currentData.headers.indexOf(columnName);
                    if (colIndex !== -1) {
                        currentData.rows[rowIndex][colIndex] = newValue;
                    }

                    // Execute callback if provided
                    if (callback) callback();

                    console.log(`Successfully updated ${columnName}`);
                } else {
                    showError(`Failed to update ${columnName}`);
                }
            })
            .withFailureHandler(function (error) {
                showError(`Error updating ${columnName}: ${error.message}`);
                console.error('Update error:', error);
            })
            .updateRow(currentTab, rowIndex + 1, updates);
    }

    /**
     * Format cell content based on column type
     * @param {*} value - Cell value
     * @param {string} header - Column header
     * @returns {string} Formatted HTML
     */
    function formatCell(value, header) {
        // Handle empty values
        if (value === null || value === undefined || value === '') {
            return '<span style="color: var(--gray-light);">â€”</span>';
        }

        // Status column (for non-editable views)
        if (header === 'Status') {
            const statusClass = getStatusClass(value);
            return `<span class="status-badge ${statusClass}">${value}</span>`;
        }

        // Priority column
        if (header === 'Priority') {
            const priorityClass = getPriorityClass(value);
            return `<span class="${priorityClass}">${value}</span>`;
        }

        // Email columns
        if (header.includes('Email')) {
            return `<a href="mailto:${value}" style="color: var(--primary); text-decoration: none;">${value}</a>`;
        }

        // Date columns (except Hard Deadline which is handled separately)
        if ((header.includes('Date') || header.includes('Timestamp') || header.includes('Modified')) && header !== 'Hard Deadline') {
            return formatDate(value);
        }

        // Default
        return escapeHtml(String(value));
    }

    /**
     * Get status badge class
     * @param {string} status - Status value
     * @returns {string} CSS class name
     */
    function getStatusClass(status) {
        const statusLower = String(status).toLowerCase();

        if (statusLower.includes('new')) return 'status-new';
        if (statusLower.includes('progress') || statusLower.includes('active')) return 'status-in-progress';
        if (statusLower.includes('complete') || statusLower.includes('done')) return 'status-completed';
        if (statusLower.includes('hold') || statusLower.includes('pending')) return 'status-on-hold';

        return 'status-new';
    }

    /**
     * Get priority class
     * @param {string} priority - Priority value
     * @returns {string} CSS class name
     */
    function getPriorityClass(priority) {
        const priorityLower = String(priority).toLowerCase();

        if (priorityLower.includes('high') || priorityLower.includes('urgent')) return 'priority-high';
        if (priorityLower.includes('medium') || priorityLower.includes('normal')) return 'priority-medium';
        if (priorityLower.includes('low')) return 'priority-low';

        return '';
    }

    /**
     * Format date string
     * @param {string} dateStr - Date string
     * @returns {string} Formatted date
     */
    function formatDate(dateStr) {
        if (!dateStr) return 'â€”';

        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            // Show relative time for recent dates
            if (diffDays === 0) {
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
                }
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            }

            // Format as date
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        } catch (e) {
            return dateStr;
        }
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Show loading state
     */
    function showLoading() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('dataGridSection').style.display = 'none';
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
    }

    /**
     * Hide loading state
     */
    function hideLoading() {
        document.getElementById('loadingState').classList.add('hidden');
    }

    /**
     * Show empty state
     */
    function showEmptyState() {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('dataGridSection').style.display = 'none';
        document.getElementById('stat-total').textContent = '0';
        document.getElementById('stat-urgent').textContent = '0';
    }

    /**
     * Show error message
     * @param {string} message - Error message
     */
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = `âš ï¸ ${message}`;
        errorDiv.classList.remove('hidden');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    }

    /**
     * Refresh current view
     */
    function refreshData() {
        loadData(currentTab);
    }

    // Auto-refresh every 5 minutes
    setInterval(refreshData, 5 * 60 * 1000);
</script>