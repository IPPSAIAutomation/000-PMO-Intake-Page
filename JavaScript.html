<script>
    console.log('Script starting execution...');
    /**
     * ========================================
     * PMO INTAKE DASHBOARD - TASK MANAGEMENT WORKSPACE
     * ========================================
     */

    // Global state
    let currentTab = 'DB_ADHOCS';
    let currentView = 'myTasks'; // 'myTasks' or 'allRequests'
    let currentProjectView = 'pending'; // 'pending', 'roadmap', or 'archive'
    let currentData = null;
    let teamMembers = [];
    let userEmail = '';
    let initTimeout = null;

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function () {
        console.log('DOM Content Loaded');
        initializeDashboard();
    });

    /**
     * Initialize the dashboard
     */
    function initializeDashboard() {
        console.log('initializeDashboard called');
        // Set a timeout to catch stuck initialization
        initTimeout = setTimeout(() => {
            console.error('Initialization timeout - Google Apps Script may not be responding');
            hideLoading();
            showError('Unable to load data. This may be due to a slow connection or script timeout. Please refresh the page to try again.');
        }, 30000); // 30 second timeout

        // Set user email from server
        google.script.run
            .withSuccessHandler(function (email) {
                userEmail = email;

                // Extract name from email (part before @)
                const userName = email.split('@')[0];
                // Capitalize first letter of each word (e.g., "ipalacio" -> "Ipalacio")
                const displayName = userName.charAt(0).toUpperCase() + userName.slice(1);

                document.getElementById('userEmail').textContent = email;
                document.querySelector('.user-name').textContent = displayName;

                // Set user avatar (first letter of name)
                const firstLetter = displayName.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;

                // Now load team members and data
                loadTeamMembersAndData();
            })
            .withFailureHandler(function (error) {
                console.error('Error getting user email:', error);
                clearTimeout(initTimeout);
                hideLoading();
                showError('Failed to load user information: ' + error.message + '. Please refresh the page.');

                // Try to continue with fallback
                userEmail = 'unknown@ucsd.edu';
                document.getElementById('userEmail').textContent = 'Error loading email';
                document.querySelector('.user-name').textContent = 'Unknown User';
                loadTeamMembersAndData();
            })
            .getUserEmail();
    }

    /**
     * Load team members and initial data
     * Called after user email is retrieved
     */
    function loadTeamMembersAndData() {
        // Load team members
        google.script.run
            .withSuccessHandler(function (members) {
                teamMembers = members;
                // Load initial data after team members are loaded
                loadData(currentTab);
            })
            .withFailureHandler(function (error) {
                console.error('Error loading team members:', error);
                clearTimeout(initTimeout);
                hideLoading();
                showError('Failed to load team members: ' + error.message + '. Some features may not work correctly.');

                // Load data anyway with empty team list
                teamMembers = [];
                loadData(currentTab);
            })
            .getTeamMembers();
    }

    /**
     * Switch between tabs
     * @param {string} tabName - Name of the tab to switch to
     */
    function switchTab(tabName) {
        // Update active state on sidebar nav buttons
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.classList.remove('active');
        });

        const activeButton = tabName === 'DB_ADHOCS' ?
            document.getElementById('nav-adhoc') :
            document.getElementById('nav-pending'); // Default to pending view for projects

        activeButton.classList.add('active');

        // Update current tab
        currentTab = tabName;

        // If switching to projects, default to pending view
        if (tabName === 'DB_PROJECTS') {
            currentProjectView = 'pending';
        }

        // Update top bar title
        const title = tabName === 'DB_ADHOCS' ? 'Ad Hoc Requests Queue' : 'Project Intake & Prioritization';
        document.getElementById('topBarTitle').textContent = title;

        // Show/hide stats section (only for Ad Hoc Requests)
        const statsSection = document.querySelector('.stats-section');
        if (statsSection) {
            if (tabName === 'DB_ADHOCS') {
                statsSection.style.display = 'block';
            } else {
                statsSection.style.display = 'none';
            }
        }

        // Show/hide filters bar (only for Ad Hoc Requests)
        const filtersBar = document.querySelector('.filters-bar');
        if (tabName === 'DB_ADHOCS') {
            filtersBar.style.display = 'flex';
        } else {
            filtersBar.style.display = 'none';
        }

        // Hide matrix container for Ad Hoc tab
        const matrixContainer = document.getElementById('matrixContainer');
        if (matrixContainer) {
            if (tabName === 'DB_ADHOCS') {
                matrixContainer.classList.add('hidden');
            }
            // Note: Matrix visibility for project views is handled in renderProjectTable()
        }

        // Update table headers based on tab
        updateTableHeaders(tabName);

        // Load data
        loadData(tabName);
    }

    /**
     * Switch between project views
     * @param {string} viewName - Name of the project view ('pending', 'roadmap', 'archive')
     */
    function switchProjectView(viewName) {
        // Update active state on sidebar nav buttons
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.classList.remove('active');
        });

        // Activate the clicked button
        const buttonId = `nav-${viewName}`;
        const activeButton = document.getElementById(buttonId);
        if (activeButton) {
            activeButton.classList.add('active');
        }

        // Update current tab and view
        currentTab = 'DB_PROJECTS';
        currentProjectView = viewName;

        // Toggle Layout Class for Pending View
        const mainContent = document.querySelector('.main-content');
        if (viewName === 'pending') {
            mainContent.classList.add('pending-layout');
        } else {
            mainContent.classList.remove('pending-layout');
        }

        // Update top bar title based on view
        const titles = {
            'pending': 'Project Intake & Prioritization - Pending Review',
            'roadmap': 'Project Intake & Prioritization - Active Roadmap',
            'archive': 'Project Intake & Prioritization - Archive'
        };
        document.getElementById('topBarTitle').textContent = titles[viewName] || 'Project Intake & Prioritization';

        // Hide stats section (not used for projects)
        const statsSection = document.querySelector('.stats-section');
        if (statsSection) {
            statsSection.style.display = 'none';
        }

        // Hide filters bar (not used for projects)
        const filtersBar = document.querySelector('.filters-bar');
        filtersBar.style.display = 'none';

        // Hide matrix container immediately to prevent ghosting
        const matrixContainer = document.getElementById('matrixContainer');
        if (matrixContainer) {
            matrixContainer.classList.add('hidden');
        }

        // Update table headers
        updateTableHeaders('DB_PROJECTS');

        // Load data
        loadData('DB_PROJECTS');
    }

    /**
     * Update table headers based on current tab
     */
    function updateTableHeaders(tabName) {
        const tableHead = document.querySelector('thead tr');

        if (tabName === 'DB_PROJECTS') {
            // Project table headers - vary by view
            if (currentProjectView === 'pending') {
                tableHead.innerHTML = `
                    <th>Project Title</th>
                    <th>Executive Sponsor</th>
                    <th>Status</th>
                    <th style="text-align: center;">Strategy</th>
                    <th style="text-align: center;">Impact</th>
                    <th>Tech Effort</th>
                    <th style="text-align: right;">Final Score</th>
                `;
            } else {
                // roadmap and archive views
                tableHead.innerHTML = `
                    <th>Project Title</th>
                    <th>Executive Sponsor</th>
                    <th>Status</th>
                    <th style="text-align: center;">Strategy Score</th>
                    <th style="text-align: center;">Impact Score</th>
                    <th style="text-align: right;">Final Score</th>
                `;
            }
        } else {
            // Ad Hoc table headers
            tableHead.innerHTML = `
                <th>Request</th>
                <th>Status</th>
                <th>Assignee</th>
                <th>Deadline</th>
                <th style="width: 48px; text-align: right;">Action</th>
            `;
        }
    }

    /**
     * Switch between views (My Active Tasks vs All Open Requests vs Archived)
     * @param {string} viewName - Name of the view
     */
    function switchView(viewName) {
        // Update active state on filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        let activeButton;
        if (viewName === 'myTasks') {
            activeButton = document.getElementById('filter-my');
        } else if (viewName === 'allRequests') {
            activeButton = document.getElementById('filter-all');
        } else if (viewName === 'archived') {
            activeButton = document.getElementById('filter-archived');
        }

        if (activeButton) {
            activeButton.classList.add('active');
        }

        // Update current view
        currentView = viewName;

        // Re-render table with filtered data
        if (currentData) {
            renderTable(currentData);
        }
    }

    /**
     * Load data from the server
     * @param {string} tabName - Name of the tab to load data from
     */
    function loadData(tabName) {
        // Show loading state
        showLoading();

        // Call server-side function
        google.script.run
            .withSuccessHandler(onDataLoaded)
            .withFailureHandler(onDataError)
            .getData(tabName);
    }

    /**
     * Handle successful data load
     * @param {Object} data - Data object with headers and rows
     */
    function onDataLoaded(data) {
        // Clear initialization timeout if it exists
        if (initTimeout) {
            clearTimeout(initTimeout);
            initTimeout = null;
        }

        currentData = data;

        // Hide loading state
        hideLoading();

        // Check if data is empty
        if (!data.rows || data.rows.length === 0) {
            showEmptyState();
            return;
        }

        // Render table
        renderTable(data);
    }

    /**
     * Handle data load error
     * @param {Error} error - Error object
     */
    function onDataError(error) {
        // Clear initialization timeout if it exists
        if (initTimeout) {
            clearTimeout(initTimeout);
            initTimeout = null;
        }

        console.error('Error loading data:', error);
        hideLoading();

        // Show user-friendly error message
        const errorMsg = error.message || 'Unknown error occurred';
        showError(`Failed to load data: ${errorMsg}. Please try refreshing the page or contact support if the issue persists.`);
    }

    /**
     * Filter data based on current view
     * @param {Object} data - Original data
     * @returns {Object} Filtered data
     */
    function filterData(data) {
        // Only filter for Ad Hoc Requests
        if (currentTab !== 'DB_ADHOCS') {
            return data;
        }

        const assigneeIndex = data.headers.indexOf('Assignee');
        const statusIndex = data.headers.indexOf('Status');

        if (assigneeIndex === -1 || statusIndex === -1) {
            console.warn('Missing required columns - Assignee index:', assigneeIndex, 'Status index:', statusIndex);
            return data;
        }

        let filteredRows;

        if (currentView === 'myTasks') {
            // Filter rows where Assignee matches current user AND Status is not "Completed" or "Cancelled"
            filteredRows = data.rows.filter(row => {
                const assignee = row[assigneeIndex];
                const status = row[statusIndex];

                // Match assignee (case-insensitive, partial match on email)
                const isMyTask = assignee && assignee.toLowerCase().includes(userEmail.toLowerCase());
                const isOpen = status !== 'Completed' && status !== 'Cancelled';

                return isMyTask && isOpen;
            });
        } else if (currentView === 'allRequests') {
            // Filter rows where Status is "New" or "In Progress"
            filteredRows = data.rows.filter(row => {
                const status = row[statusIndex];
                const isOpen = status === 'New' || status === 'In Progress';
                return isOpen;
            });
        } else if (currentView === 'archived') {
            // Filter rows where Status is "Completed" or "Cancelled"
            filteredRows = data.rows.filter(row => {
                const status = row[statusIndex];
                const isArchived = status === 'Completed' || status === 'Cancelled';
                return isArchived;
            });
        } else {
            // Default: return all data
            filteredRows = data.rows;
        }

        console.log(`‚úÖ Filtered ${filteredRows.length} rows from ${data.rows.length} total rows`);

        return {
            headers: data.headers,
            rows: filteredRows
        };
    }

    /**
     * Render the data table
     * @param {Object} data - Data object with headers and rows
     */
    function renderTable(data) {
        const tableBody = document.getElementById('tableBody');
        const dataGridSection = document.getElementById('dataGridSection');
        const tableHead = document.querySelector('thead tr');

        // Filter data based on current view
        const filteredData = filterData(data);

        // Calculate stats (removed as stats section is gone)
        // calculateStats(filteredData);

        // Check if filtered data is empty
        if (filteredData.rows.length === 0) {
            showEmptyState();
            return;
        }

        // Clear existing content
        tableBody.innerHTML = '';
        tableHead.innerHTML = ''; // Clear headers

        // Set Headers based on Tab
        if (currentTab === 'DB_PROJECTS') {
            if (currentProjectView === 'pending') {
                tableHead.innerHTML = `
                    <th>Project Title</th>
                    <th>Executive Sponsor</th>
                    <th>Status</th>
                    <th style="text-align: center;">Strategy</th>
                    <th style="text-align: center;">Impact</th>
                    <th>Tech Effort (AVG)</th>
                    <th style="text-align: right;">Final Score</th>
                `;
            } else {
                tableHead.innerHTML = `
                    <th>Project Title</th>
                    <th>Executive Sponsor</th>
                    <th>Status</th>
                    <th style="text-align: center;">Strategy Score</th>
                    <th style="text-align: center;">Impact Score</th>
                    <th style="text-align: right;">Final Score</th>
                `;
            }
            renderProjectTable(filteredData, data.headers, tableBody);
        } else {
            // Ad Hoc Headers
            tableHead.innerHTML = `
                <th>Request</th>
                <th>Status</th>
                <th>Assignee</th>
                <th>Deadline</th>
                <th style="width: 48px; text-align: right;">Action</th>
            `;
            renderAdHocTable(filteredData, data.headers, tableBody);
        }

        // Show table
        dataGridSection.style.display = 'block';
        document.getElementById('emptyState').classList.add('hidden');
    }

    /**
     * Render Ad Hoc Requests Table
     */
    function renderAdHocTable(filteredData, headers, tableBody) {
        // Get column indices
        const titleIndex = headers.indexOf('The Request');
        const statusIndex = headers.indexOf('Status');
        const assigneeIndex = headers.indexOf('Assignee');
        const deadlineIndex = headers.indexOf('Hard Deadline');
        const idIndex = headers.indexOf('Timestamp');
        const requestorIndex = headers.indexOf('Email Address');
        const requestIdIndex = headers.indexOf('Request ID'); // New column

        // Create data rows
        filteredData.rows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.dataset.rowIndex = rowIndex;
            tr.onclick = () => openDetails(row, headers);

            // Request Column (Title + Metadata)
            const tdRequest = document.createElement('td');
            const title = row[titleIndex] || 'Untitled Request';
            const requestor = row[requestorIndex] || 'Unknown';
            const timestamp = formatTimestamp(row[idIndex]);
            const requestId = row[requestIdIndex] || 'PENDING';

            tdRequest.innerHTML = `
                <div class="request-title">${escapeHtml(title)}</div>
                <div class="request-meta">
                    ${requestId} ‚Ä¢ ${escapeHtml(requestor.split('@')[0])} ‚Ä¢ <span>${timestamp}</span>
                </div>
            `;
            tr.appendChild(tdRequest);

            // Status Column
            const tdStatus = document.createElement('td');
            const status = row[statusIndex] || 'New';
            tdStatus.innerHTML = renderStatusBadge(status);
            tr.appendChild(tdStatus);

            // Assignee Column
            const tdAssignee = document.createElement('td');
            const assignee = row[assigneeIndex];
            tdAssignee.innerHTML = renderAssigneeCell(assignee);
            tr.appendChild(tdAssignee);

            // Deadline Column
            const tdDeadline = document.createElement('td');
            const deadline = row[deadlineIndex];
            tdDeadline.innerHTML = renderDeadlineCell(deadline);
            tr.appendChild(tdDeadline);

            // Action Column (Chevron)
            const tdAction = document.createElement('td');
            tdAction.style.textAlign = 'right';
            tdAction.innerHTML = '<span class="chevron-icon">‚Ä∫</span>';
            tr.appendChild(tdAction);

            tableBody.appendChild(tr);
        });
    }

    /**
     * Render Project Requests Table
     */
    function renderProjectTable(filteredData, headers, tableBody) {
        // Get column indices
        const titleIndex = headers.indexOf('Project Title');
        const sponsorIndex = headers.indexOf('Executive Sponsor');
        const statusIndex = headers.indexOf('Status');

        // New Scoring Columns
        const stratIndex = headers.indexOf('Strategy Score');
        const impactIndex = headers.indexOf('Impact Score');
        const techEffortIndex = headers.indexOf('Tech Effort'); // Average 1-5
        const finalScoreIndex = headers.indexOf('Final Score');

        // Fallback to AI columns if new ones empty (migration support)
        const aiStrategyIndex = headers.indexOf('AI Strategy Score');
        const aiImpactIndex = headers.indexOf('AI Impact Score');

        // Filter data based on current project view
        let viewFilteredRows = filteredData.rows;
        if (currentProjectView === 'pending') {
            viewFilteredRows = filteredData.rows.filter(row => {
                const status = row[statusIndex] || '';
                return status === 'Pending Review' || status === 'New' || status === '' || status.trim() === '';
            });
        } else if (currentProjectView === 'roadmap') {
            viewFilteredRows = filteredData.rows.filter(row => {
                const status = row[statusIndex] || '';
                return status === 'Approved' || status === 'In Progress';
            });
            viewFilteredRows.sort((a, b) => (parseFloat(b[finalScoreIndex]) || 0) - (parseFloat(a[finalScoreIndex]) || 0));
        } else if (currentProjectView === 'archive') {
            viewFilteredRows = filteredData.rows.filter(row => {
                const status = row[statusIndex] || '';
                return status === 'Completed' || status === 'Rejected';
            });
        }

        // Show/hide matrix container based on view
        const matrixContainer = document.getElementById('matrixContainer');
        if (currentProjectView === 'pending') {
            matrixContainer.classList.remove('hidden');
            // Pass ALL rows to renderMatrixBubbles for reference bubbles
            renderMatrixBubbles(viewFilteredRows, filteredData.rows, headers);
        } else {
            matrixContainer.classList.add('hidden');
        }

        // Create data rows
        viewFilteredRows.forEach((row, rowIndex) => {
            const originalRowIndex = filteredData.rows.indexOf(row);
            const tr = document.createElement('tr');
            tr.dataset.rowIndex = originalRowIndex;

            // FIX: Attach click handler to the entire row (like Ad Hoc view)
            tr.style.cursor = 'pointer';

            // Interaction: Row -> Matrix Highlight
            tr.onmouseenter = () => highlightMatrixBubble(originalRowIndex, true);
            tr.onmouseleave = () => highlightMatrixBubble(originalRowIndex, false);

            tr.onclick = (e) => {
                // Prevent opening if clicking a button/input inside the row
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                openDetails(row, headers);
            };

            // 1. Project Title Column
            const tdTitle = document.createElement('td');
            const title = row[titleIndex] || 'Untitled Project';
            const projectId = `PROJ-${String(originalRowIndex + 1).padStart(3, '0')}`;

            tdTitle.innerHTML = `
                <div class="request-title" style="color: var(--blue-600); font-weight: 600;">${escapeHtml(title)}</div>
                <div class="request-meta">${projectId}</div>
            `;
            tr.appendChild(tdTitle);

            // 2. Executive Sponsor Column
            const tdSponsor = document.createElement('td');
            const sponsor = row[sponsorIndex] || 'Unknown';
            tdSponsor.innerHTML = `<span style="color: var(--slate-600); font-size: 0.875rem;">${escapeHtml(sponsor)}</span>`;
            tr.appendChild(tdSponsor);

            // 3. Status Column
            const tdStatus = document.createElement('td');
            const status = row[statusIndex] || 'Pending Review';
            if (currentProjectView === 'roadmap' && status === 'In Progress') {
                tdStatus.innerHTML = `<span class="status-badge status-in-progress-blue">${escapeHtml(status)}</span>`;
            } else {
                tdStatus.innerHTML = renderStatusBadge(status);
            }
            tr.appendChild(tdStatus);

            // Fetch Score Values
            const stratScore = parseInt(row[stratIndex]) || parseInt(row[aiStrategyIndex]) || 0;
            const impactScore = parseInt(row[impactIndex]) || parseInt(row[aiImpactIndex]) || 0;
            const techEffort = parseFloat(row[techEffortIndex]) || 1;
            const finalScore = parseFloat(row[finalScoreIndex]) || 0;

            // 4. Strategy Score Column
            const tdStrat = document.createElement('td');
            tdStrat.innerHTML = `<div style="text-align: center; font-weight: 600; color: var(--slate-700);">${stratScore || '-'}</div>`;
            tr.appendChild(tdStrat);

            // 5. Impact Score Column
            const tdImpact = document.createElement('td');
            tdImpact.innerHTML = `<div style="text-align: center; font-weight: 600; color: var(--slate-700);">${impactScore || '-'}</div>`;
            tr.appendChild(tdImpact);

            // 6. Tech Effort Column (ONLY FOR PENDING VIEW)
            if (currentProjectView === 'pending') {
                const tdEffort = document.createElement('td');
                const tooltipTitle = `Strategy: ${stratScore} | Impact: ${impactScore} | Effort: ${techEffort.toFixed(1)} | Final Score: ${finalScore.toFixed(1)}`;

                // Create 5 dots visual
                let dotsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    const isActive = Math.round(techEffort) >= i;
                    const color = isActive ? '#6366f1' : '#e2e8f0';
                    dotsHtml += `<div style="width: 8px; height: 8px; border-radius: 50%; background: ${color};"></div>`;
                }

                tdEffort.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: start; gap: 0.25rem;" title="${tooltipTitle}">
                        <div style="display: flex; gap: 4px;">${dotsHtml}</div>
                        <div style="font-size: 0.75rem; color: var(--slate-500); font-family: monospace;">${techEffort.toFixed(1)} / 5</div>
                    </div>
                `;
                tr.appendChild(tdEffort);
            }

            // 7. Final Score Column (For Pending, Roadmap, and Archive)
            const tdFinal = document.createElement('td');
            tdFinal.innerHTML = `
                <div style="font-size: 1.25rem; font-weight: 800; color: var(--slate-900); text-align: right;">
                    ${finalScore > 0 ? finalScore.toFixed(1) : '-'}
                </div>
            `;
            tr.appendChild(tdFinal);

            tableBody.appendChild(tr);
        });
    }

    /**
     * Render matrix bubbles for pending project view
     * @param {Array} pendingRows - Pending project rows (Active Bubbles)
     * @param {Array} allRows - All project rows (for Reference Bubbles)
     * @param {Array} headers - Column headers
     */
    function renderMatrixBubbles(pendingRows, allRows, headers) {
        const bubblesContainer = document.getElementById('matrixBubbles');
        if (!bubblesContainer) return;

        // Clear existing bubbles
        bubblesContainer.innerHTML = '';

        // Get column indices
        const titleIndex = headers.indexOf('Project Title');
        const statusIndex = headers.indexOf('Status');
        const techEffortIndex = headers.indexOf('Tech Effort');
        // Try new columns, fallback to AI columns
        const stratIndex = headers.indexOf('Strategy Score');
        const impactIndex = headers.indexOf('Impact Score');
        const aiStratIndex = headers.indexOf('AI Strategy Score');
        const aiImpIndex = headers.indexOf('AI Impact Score');

        // Iterate over ALL rows to include "Ghost" projects
        allRows.forEach((row, index) => {
            // Determine if this is a pending row (Active) or Reference
            const isPending = pendingRows.includes(row);
            const status = row[statusIndex] || '';

            // Reference: Active projects (In Progress/Approved) that are NOT in the pending list
            const isReference = !isPending && (status === 'In Progress' || status === 'Approved');

            // Skip if neither pending nor reference
            if (!isPending && !isReference) return;

            const title = row[titleIndex] || 'Untitled';

            // Get values
            const techEffort = parseFloat(row[techEffortIndex]) || 1; // 1-5 scale
            const strategy = parseInt(row[stratIndex]) || parseInt(row[aiStratIndex]) || 0;
            const impact = parseInt(row[impactIndex]) || parseInt(row[aiImpIndex]) || 0;

            // Skip if no scores
            if (strategy === 0 && impact === 0) return;

            // Calculate position (0-100%)
            const position = calculateBubblePosition(techEffort, impact);

            // Calculate size based on strategy/value (20-60px)
            const size = 20 + (strategy / 10) * 40;

            // Get color based on quadrant
            const color = getQuadrantColor(techEffort, impact);

            // Create bubble element
            const bubble = document.createElement('div');
            bubble.className = 'matrix-bubble';
            if (isReference) {
                bubble.classList.add('reference');
            }

            // Store Row Index for bidirectional highlighting
            bubble.dataset.rowIndex = index;

            bubble.style.left = `${position.x}%`;
            bubble.style.top = `${position.y}%`;
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;

            if (!isReference) {
                bubble.style.background = color.bg;
                bubble.style.borderColor = color.border;
            }

            bubble.style.transform = 'translate(-50%, -50%)';

            // Interaction: Matrix -> List Scroll
            if (isPending) {
                bubble.onclick = (e) => {
                    e.stopPropagation(); // Prevent bubbling layout clicks
                    scrollToRow(index);
                };
            }

            // Add tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'matrix-bubble-tooltip';
            const typeLabel = isReference ? '<span style="color:#94a3b8">(Active Ref)</span> ' : '';
            tooltip.innerHTML = `${typeLabel}<strong>${escapeHtml(title)}</strong><br>Strat: ${strategy} | Imp: ${impact} | Eff: ${techEffort}`;
            bubble.appendChild(tooltip);

            bubblesContainer.appendChild(bubble);
        });
    }

    /**
     * Highlight a matrix bubble corresponding to a table row
     */
    function highlightMatrixBubble(rowIndex, isActive) {
        const bubble = document.querySelector(`.matrix-bubble[data-row-index="${rowIndex}"]`);
        if (bubble) {
            if (isActive) {
                bubble.classList.add('active-highlight');
            } else {
                bubble.classList.remove('active-highlight');
            }
        }
    }

    /**
     * Scroll to and highlight a table row
     */
    function scrollToRow(rowIndex) {
        const tr = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (tr) {
            tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
            tr.classList.add('highlight-row');

            // Remove highlight after animation
            setTimeout(() => {
                tr.classList.remove('highlight-row');
            }, 2000);
        }
    }

    /**
     * Calculate bubble position on matrix
     * @param {number} techEffort - Tech effort (1-5) -> X Axis
     * @param {number} impact - Impact Score (1-10) -> Y Axis
     * @returns {Object} Position {x, y} in percentage
     */
    function calculateBubblePosition(techEffort, impact) {
        // X-axis: Tech Effort (1-5) -> 0-100%
        // 1=Left, 5=Right
        const x = ((techEffort - 1) / 4) * 100;

        // Y-axis: Impact (1-10) -> 100-0% (inverted because high impact is at top)
        // 10=Top(0%), 1=Bottom(100%)
        const y = 100 - ((impact - 1) / 9) * 100;

        return { x, y };
    }

    /**
     * Get quadrant color based on position
     * @param {number} techEffort - Tech effort (1-5)
     * @param {number} impact - Impact score (1-10)
     * @returns {Object} Color {bg, border}
     */
    function getQuadrantColor(techEffort, impact) {
        // Thresholds: Effort > 2.5 is "High", Impact > 5 is "High"
        const isHighEffort = techEffort > 2.5;
        const isHighImpact = impact > 5;

        if (isHighImpact && !isHighEffort) {
            // Q1: High Impact, Low Effort (Success/Quick Win) - Green
            return { bg: 'rgba(16, 185, 129, 0.2)', border: '#10b981' };
        } else if (isHighImpact && isHighEffort) {
            // Q2: High Impact, High Effort (Strategic) - Indigo/Blue
            return { bg: 'rgba(99, 102, 241, 0.2)', border: '#6366f1' };
        } else if (!isHighImpact && isHighEffort) {
            // Q3: Low Impact, High Effort (Avoid) - Red
            return { bg: 'rgba(239, 68, 68, 0.2)', border: '#ef4444' };
        } else {
            // Q4: Low Impact, Low Effort (Maintenance) - Slate/Gray
            return { bg: 'rgba(148, 163, 184, 0.2)', border: '#94a3b8' };
        }
    }

    /**
     * Toggle scoring guide modal
     */
    function toggleScoringModal() {
        const modal = document.getElementById('scoringModal');
        if (modal) {
            modal.classList.toggle('hidden');
        }
    }

    /**
     * Calculate and update stats
     * @param {Object} data - Filtered data
     */
    function calculateStats(data) {
        const total = data.rows.length;

        // Calculate urgent (due < 48 hours)
        const deadlineIndex = currentData.headers.indexOf('Hard Deadline');
        const now = new Date();
        let urgent = 0;

        data.rows.forEach(row => {
            const deadlineStr = row[deadlineIndex];
            if (deadlineStr) {
                try {
                    const deadline = new Date(deadlineStr);
                    const diffHours = (deadline - now) / (1000 * 60 * 60);
                    if (diffHours > 0 && diffHours <= 48) {
                        urgent++;
                    }
                } catch (e) {
                    // Ignore invalid dates
                }
            }
        });

        // Calculate new count for badge
        const statusIndex = currentData.headers.indexOf('Status');
        const newCount = currentData.rows.filter(row => row[statusIndex] === 'New').length;

        // Update UI
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-urgent').textContent = urgent;
        document.getElementById('badge-new').textContent = newCount;
    }

    /**
     * Render priority icon
     * @param {string} priority - Priority value
     * @returns {string} HTML
     */
    function renderPriorityIcon(priority) {
        const priorityLower = String(priority).toLowerCase();

        if (priorityLower.includes('high')) {
            return '<div class="priority-icon priority-high">‚ö†</div>';
        } else if (priorityLower.includes('medium')) {
            return '<div class="priority-icon"><div class="priority-medium"></div></div>';
        } else {
            return '<div class="priority-icon"><div class="priority-low"></div></div>';
        }
    }

    /**
     * Render status badge
     * @param {string} status - Status value
     * @returns {string} HTML
     */
    function renderStatusBadge(status) {
        const statusLower = String(status).toLowerCase();
        let className = 'status-new';

        if (statusLower.includes('progress')) {
            className = 'status-in-progress';
        } else if (statusLower.includes('complete')) {
            className = 'status-completed';
        } else if (statusLower.includes('review')) {
            className = 'status-review';
        } else if (statusLower.includes('cancel')) {
            className = 'status-cancelled';
        } else if (statusLower.includes('reject')) {
            className = 'status-rejected';
        } else if (statusLower.includes('approv')) {
            className = 'status-approved';
        }

        return `<span class="status-badge ${className}">${escapeHtml(status)}</span>`;
    }

    /**
     * Render assignee cell
     * @param {string} assignee - Assignee email
     * @returns {string} HTML
     */
    function renderAssigneeCell(assignee) {
        if (!assignee || assignee.trim() === '') {
            return '<span class="unassigned">Unassigned</span>';
        }

        const initial = assignee.charAt(0).toUpperCase();
        const name = assignee.split('@')[0];

        return `
            <div class="assignee-cell">
                <div class="assignee-avatar">${initial}</div>
                <span class="assignee-name">${escapeHtml(name)}</span>
            </div>
        `;
    }

    /**
     * Render deadline cell
     * @param {string} dateStr - Date string
     * @returns {string} HTML
     */
    function renderDeadlineCell(dateStr) {
        if (!dateStr) {
            return '<span style="color: var(--slate-300);">‚Äî</span>';
        }

        try {
            const deadline = new Date(dateStr);
            if (isNaN(deadline.getTime())) return escapeHtml(dateStr);

            const now = new Date();
            const diffHours = (deadline - now) / (1000 * 60 * 60);

            let className = 'deadline-normal';
            if (diffHours < 0 || diffHours <= 48) {
                className = 'deadline-warning';
            }

            const formattedDate = deadline.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });

            return `
                <div class="deadline-cell ${className}">
                    <span class="deadline-icon">üìÖ</span>
                    ${formattedDate}
                </div>
            `;
        } catch (e) {
            return escapeHtml(dateStr);
        }
    }



    /**
     * Format timestamp for display
     * @param {string} timestamp - Timestamp string
     * @returns {string} Formatted timestamp
     */
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'recently';

        try {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 60) {
                return `${diffMins} mins ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hours ago`;
            } else if (diffDays === 1) {
                return '1 day ago';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        } catch (e) {
            return 'recently';
        }
    }

    /**
     * Open details panel
     * @param {Array} row - Row data
     * @param {Array} headers - Column headers
     */
    function openDetails(row, headers) {
        const panel = document.getElementById('detailsPanel');
        const detailsBody = document.getElementById('detailsBody');

        // Determine if this is a Project or Ad Hoc request
        const isProject = currentTab === 'DB_PROJECTS';

        // Store current row index for updates
        const rowIndex = currentData.rows.indexOf(row);
        panel.dataset.rowIndex = rowIndex;
        panel.dataset.isProject = isProject;

        if (isProject) {
            renderProjectDetails(row, headers, panel, detailsBody, rowIndex);
        } else {
            renderAdHocDetails(row, headers, panel, detailsBody, rowIndex);
        }

        // Show panel
        panel.classList.add('open');
    }

    /**
     * Render Ad Hoc Request Details
     */
    function renderAdHocDetails(row, headers, panel, detailsBody, rowIndex) {
        // Get data
        const titleIndex = headers.indexOf('The Request');
        const statusIndex = headers.indexOf('Status');
        const assigneeIndex = headers.indexOf('Assignee');
        const justificationIndex = headers.indexOf('Business Justification');
        const filtersIndex = headers.indexOf('Required Filters / Inclusions');
        const outputIndex = headers.indexOf('Output Format Expectation');
        const requestorIndex = headers.indexOf('Email Address');
        const deliverableIndex = headers.indexOf('Deliverable Evidence');
        const requestIdIndex = headers.indexOf('Request ID'); // New column

        const title = row[titleIndex] || 'Untitled Request';
        const status = row[statusIndex] || 'New';
        const assignee = row[assigneeIndex] || '';
        const justification = row[justificationIndex] || 'No justification provided';
        const filters = row[filtersIndex] || 'No filters specified';
        const output = row[outputIndex] || 'Not specified';
        const requestor = row[requestorIndex] || 'Unknown';
        const deliverable = row[deliverableIndex] || '';
        const requestId = row[requestIdIndex] || 'PENDING';

        // Update header
        document.getElementById('detailId').textContent = requestId;
        document.getElementById('detailTitle').textContent = title;

        // Render clickable status badge with dropdown
        const statusContainer = document.getElementById('detailStatus');
        statusContainer.innerHTML = `
            <div style="position: relative; display: inline-block;">
                <button 
                    onclick="toggleStatusDropdown(event)" 
                    style="background: none; border: none; padding: 0; cursor: pointer;"
                    aria-label="Change status"
                >
                    ${renderStatusBadge(status)}
                </button>
                <div id="statusDropdown" class="status-dropdown" style="display: none;">
                    <div class="status-dropdown-header">CHANGE STATUS</div>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'New')" data-status="New">
                        <span class="status-dot" style="background: #3b82f6;"></span>
                        New
                        ${status === 'New' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'In Progress')" data-status="In Progress">
                        <span class="status-dot" style="background: #f59e0b;"></span>
                        In Progress
                        ${status === 'In Progress' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'Cancelled')" data-status="Cancelled">
                        <span class="status-dot" style="background: #ef4444;"></span>
                        Cancelled
                        ${status === 'Cancelled' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                </div>
            </div>
        `;

        // Build details body
        const assigneeInitial = assignee ? assignee.charAt(0).toUpperCase() : '?';
        const assigneeName = assignee || 'Unassigned';
        const requestorName = requestor.split('@')[0];

        // Build assignee dropdown options
        const assigneeOptions = teamMembers.map(member => {
            const selected = member === assignee ? 'selected' : '';
            return `<option value="${escapeHtml(member)}" ${selected}>${escapeHtml(member)}</option>`;
        }).join('');
        const unassignedSelected = (!assignee || assignee.trim() === '') ? 'selected' : '';
        const allAssigneeOptions = `<option value="" ${unassignedSelected}>Unassigned</option>${assigneeOptions}`;

        detailsBody.innerHTML = `
            <!-- Owner Section -->
            <div class="details-section">
                <div class="section-header">
                    <span class="section-label">Owner</span>
                    <button class="btn-change" onclick="toggleAssigneeDropdown()">Change</button>
                </div>
                <div class="owner-info" id="ownerDisplay">
                    <div class="owner-avatar">${assigneeInitial}</div>
                    <div>
                        <p class="owner-name">${escapeHtml(assigneeName)}</p>
                        <p class="owner-role">BI Analyst</p>
                    </div>
                </div>
                <div id="ownerEdit" style="display: none;">
                    <select class="assignee-select" id="detailAssigneeSelect" style="width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--slate-300);">
                        ${allAssigneeOptions}
                    </select>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn-complete" onclick="saveAssigneeFromDetails()" style="flex: 1; padding: 0.375rem;">Save</button>
                        <button class="btn-reject" onclick="cancelAssigneeEdit()" style="padding: 0.375rem 0.75rem;">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Request Details -->
            <div style="margin-bottom: 2rem;">
                <div style="margin-bottom: 1rem;">
                    <h3 class="field-label">
                        <span class="field-icon blue">üìÑ</span>
                        Business Justification
                    </h3>
                    <div class="field-content">${escapeHtml(justification)}</div>
                </div>

                <div class="field-grid" style="margin-bottom: 1rem;">
                    <div>
                        <h3 class="field-label">
                            <span class="field-icon purple">üîΩ</span>
                            Filters Needed
                        </h3>
                        <div class="field-content">${escapeHtml(filters)}</div>
                    </div>
                    <div>
                        <h3 class="field-label">
                            <span class="field-icon emerald">üìä</span>
                            Output Format
                        </h3>
                        <div class="field-content">${escapeHtml(output)}</div>
                    </div>
                </div>

                <div>
                    <h3 class="field-label">
                        <span class="field-icon slate">üë§</span>
                        Requestor Contact
                    </h3>
                    <div class="contact-card">
                        <div class="contact-info">
                            <div class="contact-icon">‚úâ</div>
                            <div>
                                <p class="contact-name">${escapeHtml(requestorName)}</p>
                                <p class="contact-email">${escapeHtml(requestor)}</p>
                            </div>
                        </div>
                        <button class="btn-email" onclick="window.location.href='mailto:${escapeHtml(requestor)}'">Send Email</button>
                    </div>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="details-section" style="margin-bottom: 2rem;">
                <div class="section-header">
                    <h3 class="field-label" style="margin: 0;">
                        <span class="field-icon" style="color: var(--amber-700);">üìù</span>
                        Analyst Notes
                    </h3>
                    <span style="font-size: 0.75rem; color: var(--slate-400);" id="notesCharCount">0 / 1000</span>
                </div>
                <div style="margin-top: 0.75rem;">
                    <textarea 
                        id="notesTextarea"
                        class="notes-textarea"
                        placeholder="Add status updates, cancellation reasons, or any relevant notes about this request..."
                        maxlength="1000"
                        rows="6"
                        onblur="saveNotes(${rowIndex}, this.value)"
                        oninput="updateNotesCharCount(this.value)"
                    >${escapeHtml(row[headers.indexOf('Notes')] || '')}</textarea>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--slate-400); display: flex; align-items: center; gap: 0.5rem;">
                        <span>üí°</span>
                        <span>Notes are saved automatically and visible to all team members</span>
                    </div>
                </div>
            </div>

            <!-- Action Area -->
            <div class="action-section">
                <h3>Deliverable Evidence</h3>
                <input 
                    type="text" 
                    id="deliverableInput"
                    class="action-input" 
                    placeholder="Paste link to dashboard/file..."
                    value="${escapeHtml(deliverable)}"
                    onblur="saveDeliverableEvidence(${rowIndex}, this.value)"
                >
                <div class="action-buttons">
                    <button class="btn-complete" onclick="markAdHocComplete(${rowIndex})">Mark Complete</button>
                </div>
            </div>
        `;
    }

    /**
     * Render Project Request Details (Assessment & Scoring)
     */
    function renderProjectDetails(row, headers, panel, detailsBody, rowIndex) {
        try {
            // Get project-specific data
            const titleIndex = headers.indexOf('Project Title');
            const statusIndex = headers.indexOf('Status');
            const sponsorIndex = headers.indexOf('Executive Sponsor');
            const problemIndex = headers.indexOf('Problem Statement');
            const impactDescIndex = headers.indexOf('Impact Quantification');

            // Scoring Fields
            const stratIndex = headers.indexOf('Strategy Score');
            const impactIndex = headers.indexOf('Impact Score');
            const dataIndex = headers.indexOf('Data Score');
            const stakeIndex = headers.indexOf('Stakeholder Score');
            const implIndex = headers.indexOf('Implementation Score');
            // const techDistIndex = headers.indexOf('Tech Effort'); // Unused
            // const finalScoreIndex = headers.indexOf('Final Score'); // Unused
            const techNotesIndex = headers.indexOf('Tech Notes');

            // Safe Getters
            const title = row[titleIndex] || 'Untitled Project';
            const status = row[statusIndex] || 'Pending Review';
            const sponsor = row[sponsorIndex] || 'Unknown';
            const problem = row[problemIndex] || 'No problem statement provided';
            const impactDesc = row[impactDescIndex] || 'Not specified';
            const techNotes = row[techNotesIndex] || '';

            // Parse Scores (Default to 0/empty to show unset state if needed, or defaults)
            const stratScore = parseInt(row[stratIndex]) || 5;
            const impactScore = parseInt(row[impactIndex]) || 5;

            const dataScore = parseInt(row[dataIndex]) || 1;
            const stakeScore = parseInt(row[stakeIndex]) || 1;
            const implScore = parseInt(row[implIndex]) || 1;

            // Calculate initial values
            const avgTech = calculateAvgTech({ data: dataScore, stake: stakeScore, impl: implScore });
            const finalScore = calculateFinalScore(stratScore, impactScore, avgTech);

            // Update header
            const detailId = document.getElementById('detailId');
            const detailTitle = document.getElementById('detailTitle');
            const detailStatus = document.getElementById('detailStatus');

            if (detailId) detailId.textContent = `PROJ-${String(rowIndex + 1).padStart(3, '0')}`;
            if (detailTitle) detailTitle.textContent = title;
            if (detailStatus) detailStatus.innerHTML = renderStatusBadge(status);

            // Determine Action Footer Content based on Status
            let actionFooterHtml = '';
            const statusLower = String(status).toLowerCase();

            if (statusLower === 'pending review' || statusLower === 'new' || statusLower === '') {
                actionFooterHtml = `
                    <div class="action-footer">
                        <button class="btn-reject-outline" onclick="handleProjectDecision(${rowIndex}, 'Rejected')">
                            üö´ Reject Project
                        </button>
                        <button class="btn-approve-solid" onclick="handleProjectDecision(${rowIndex}, 'Approved')">
                            ‚úÖ Approve Project
                        </button>
                    </div>
                `;
            } else if (statusLower === 'approved') {
                actionFooterHtml = `
                    <div class="action-footer">
                        <button class="btn-new-request" onclick="handleStartProject(${rowIndex})" style="width: 100%; justify-content: center;">
                            Start Project
                        </button>
                    </div>
                `;
            } else if (statusLower === 'in progress') {
                actionFooterHtml = `
                    <div class="action-footer" style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="impactConfirmCheckbox" onchange="toggleCompleteButton(this)">
                            <label for="impactConfirmCheckbox" style="font-size: 0.875rem; color: var(--slate-700); cursor: pointer;">
                                I confirm the project impact has been quantified.
                            </label>
                        </div>
                        <button id="btnCompleteProject" class="btn-complete" onclick="handleMarkProjectComplete(${rowIndex})" disabled style="width: 100%; justify-content: center; opacity: 0.5; cursor: not-allowed;">
                            Mark as Complete
                        </button>
                    </div>
                `;
            }

            // Render Template
            detailsBody.innerHTML = `
                <!-- Executive Sponsor (Full Width) -->
                <div class="info-card full-width" style="margin-bottom: 1.5rem;">
                    <div class="label">Executive Sponsor</div>
                    <div class="value">
                        <div class="user-chip">
                            <div class="chip-avatar">${sponsor.charAt(0)}</div>
                            ${escapeHtml(sponsor)}
                        </div>
                    </div>
                </div>

                <!-- Problem Statement (Blue Accent Card) -->
                <div class="detail-card detail-card-blue" style="margin-bottom: 1.5rem;">
                    <div class="card-label">PROBLEM STATEMENT</div>
                    <div class="card-content rich-text">${escapeHtml(problem)}</div>
                </div>

                 <!-- Impact Quantification (Emerald Accent Card) -->
                <div class="detail-card detail-card-emerald" style="margin-bottom: 2.5rem;">
                    <div class="card-label">IMPACT QUANTIFICATION</div>
                    <div class="card-content rich-text">${escapeHtml(impactDesc)}</div>
                </div>

                <!-- Strategic Assessment (Sliders) -->
                
                <!-- AI Scoring Button -->
                <button 
                    id="btn-ai-score-${rowIndex}"
                    onclick="handleAIScoring(${rowIndex})"
                    style="
                        width: 100%; 
                        padding: 0.75rem; 
                        margin-bottom: 1.5rem; 
                        background: #7e22ce; 
                        color: white; 
                        border: none; 
                        border-radius: 0.5rem; 
                        font-weight: 600; 
                        cursor: pointer; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        gap: 0.5rem;
                        transition: background 0.2s;
                    "
                    onmouseover="this.style.background='#6b21a8'"
                    onmouseout="this.style.background='#7e22ce'"
                >
                    <span style="font-size: 1.25rem;">‚ú®</span> Let AI score this project
                </button>

                <div class="divider-title">
                    <span class="icon">üìä</span> STRATEGIC ASSESSMENT
                </div>

                <div class="assessment-card">
                    <!-- Strategy Slider -->
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                üöÄ Strategy Score
                                <span class="sub-label">Alignment with organizational goals.</span>
                            </div>
                            <div class="slider-value" id="disp-strat">${stratScore}</div>
                        </div>
                        <input type="range" min="1" max="10" value="${stratScore}" 
                            class="range-slider strat-slider"
                            oninput="handleScoreChange(${rowIndex}, 'strat', this.value)">
                        <div class="slider-range-labels">
                            <span>1 (Low)</span>
                            <span>10 (High)</span>
                        </div>
                    </div>

                    <div class="slider-divider"></div>

                    <!-- Impact Slider -->
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                üíé Impact Score
                                <span class="sub-label">Estimated ROI and operational benefit.</span>
                            </div>
                            <div class="slider-value" id="disp-impact">${impactScore}</div>
                        </div>
                        <input type="range" min="1" max="10" value="${impactScore}" 
                            class="range-slider impact-slider"
                            oninput="handleScoreChange(${rowIndex}, 'impact', this.value)">
                        <div class="slider-range-labels">
                            <span>1 (Low)</span>
                            <span>10 (High)</span>
                        </div>
                    </div>
                </div>

                <!-- Technical Review (3 Inputs) -->
                <div class="divider-title">
                    <span class="icon">‚öôÔ∏è</span> PMO TECHNICAL REVIEW
                </div>

                <div class="tech-card" style="margin-bottom: 2rem;">
                    <!-- 1. Data & Infrastructure -->
                    <div class="tech-input-row">
                        <div class="tech-label">
                            Data & Infrastructure
                            <span class="tooltip">Complexity of data sources and pipeline needs.</span>
                        </div>
                        <div class="segment-control">
                            ${renderSegmentOptions(rowIndex, 'data', dataScore)}
                        </div>
                    </div>

                    <!-- 2. Stakeholder & Scope -->
                    <div class="tech-input-row">
                        <div class="tech-label">
                            Stakeholder & Scope
                            <span class="tooltip">Number of departments and clarity of requirements.</span>
                        </div>
                        <div class="segment-control">
                            ${renderSegmentOptions(rowIndex, 'stake', stakeScore)}
                        </div>
                    </div>

                    <!-- 3. Implementation & Logic -->
                    <div class="tech-input-row">
                        <div class="tech-label">
                            Implementation & Logic
                            <span class="tooltip">Code complexity and business logic depth.</span>
                        </div>
                        <div class="segment-control">
                            ${renderSegmentOptions(rowIndex, 'impl', implScore)}
                        </div>
                    </div>

                    <!-- Average Display -->
                    <div class="tech-avg-display">
                        <span>Avg. Technical Effort</span>
                        <span class="avg-value"><span id="disp-avg-tech">${avgTech}</span> <span class="max">/ 5.0</span></span>
                    </div>
                </div>

                <!-- Technical Notes (Styled Container) -->
                <div class="tech-notes-card">
                    <div class="notes-header">
                        <span class="icon">üìù</span>
                        TECHNICAL CONSTRAINTS / NOTES
                    </div>
                    <div class="notes-body">
                        <textarea class="styled-textarea" 
                            placeholder="Add specific technical requirements, limitations, or risk factors..."
                            onblur="handleTechNotesChange(${rowIndex}, this.value)">${escapeHtml(techNotes)}</textarea>
                    </div>
                </div>

                <!-- Real-Time Calculation Card -->
                <div class="final-score-card">
                    <div class="score-header">
                        <div class="score-icon">üèÅ</div>
                        <div class="score-title">Final Prioritization</div>
                    </div>
                    <div class="score-formula">
                        (Strategy + Impact) / Tech Effort
                        <br>
                        (<span id="formula-strat">${stratScore}</span> + <span id="formula-impact">${impactScore}</span>) / <span id="formula-eff">${avgTech}</span>
                    </div>
                    <div class="score-result" id="disp-final-score">${finalScore}</div>
                    
                    <!-- Manual Save Button -->
                    <div style="margin-top: 1rem; text-align: right; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                        <button id="btnManualSave" onclick="handleManualSave(${rowIndex})" style="background: var(--blue-600); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer;">
                            Save Scoring
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                ${actionFooterHtml}
            `;
        } catch (e) {
            console.error('Error in renderProjectDetails:', e);
            detailsBody.innerHTML = '<p class="error-message">Error rendering details. Please check console.</p>';
        }
    }

    /**
     * Helper to toggle completion button based on impact confirmation
     */
    function toggleCompleteButton(checkbox) {
        const btn = document.getElementById('btnCompleteProject');
        if (btn) {
            btn.disabled = !checkbox.checked;
            btn.style.opacity = checkbox.checked ? '1' : '0.5';
            btn.style.cursor = checkbox.checked ? 'pointer' : 'not-allowed';
        }
    }

    /**
     * Handle Start Project (Roadmap View)
     */
    function handleStartProject(rowIndex) {
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');

        // Update local data
        row[statusIndex] = 'In Progress';

        // Update UI
        const statusElement = document.getElementById('detailStatus');
        if (statusElement) {
            statusElement.innerHTML = renderStatusBadge('In Progress');
        }

        // Update database
        updateField(rowIndex, 'Status', 'In Progress', function () {
            // Close panel and reload to refresh the table
            closeDetails();
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Handle Mark Project Complete (Roadmap View)
     */
    function handleMarkProjectComplete(rowIndex) {
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');

        // Update local data
        row[statusIndex] = 'Completed';

        // Update UI
        const statusElement = document.getElementById('detailStatus');
        if (statusElement) {
            statusElement.innerHTML = renderStatusBadge('Completed');
        }

        // Update database
        updateField(rowIndex, 'Status', 'Completed', function () {
            // Close panel and reload to refresh the table
            closeDetails();
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Close details panel
     */
    function closeDetails() {
        const panel = document.getElementById('detailsPanel');
        panel.classList.remove('open');
    }

    /**
     * Toggle assignee dropdown in details panel
     */
    function toggleAssigneeDropdown() {
        const ownerDisplay = document.getElementById('ownerDisplay');
        const ownerEdit = document.getElementById('ownerEdit');

        ownerDisplay.style.display = 'none';
        ownerEdit.style.display = 'block';
    }

    /**
     * Save assignee from details panel
     */
    function saveAssigneeFromDetails() {
        const panel = document.getElementById('detailsPanel');
        const rowIndex = parseInt(panel.dataset.rowIndex);
        const select = document.getElementById('detailAssigneeSelect');
        const newValue = select.value;

        updateField(rowIndex, 'Assignee', newValue, function () {
            // Close the panel and reload data
            closeDetails();
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Handle AI Scoring
     */
    function handleAIScoring(rowIndex) {
        const btn = document.getElementById(`btn-ai-score-${rowIndex}`);
        const originalText = btn.innerHTML;

        // 1. Change State
        btn.innerHTML = '<span class="spinner"></span> Analyzing...'; // You might need a spinner CSS class, or just text
        btn.disabled = true;
        btn.style.opacity = '0.7';
        btn.style.cursor = 'wait';

        // 2. Call Backend
        google.script.run
            .withSuccessHandler(function (result) {
                console.log('AI Result:', result);

                // 3. Update UI with Results

                // Update Sliders & Text
                if (result.strat_score) {
                    // Update input value FIRST so handleScoreChange reads the new value
                    const stratSlider = document.querySelector('.strat-slider');
                    if (stratSlider) {
                        stratSlider.value = result.strat_score;
                        handleScoreChange(rowIndex, 'strat', result.strat_score);
                    }
                }

                if (result.impact_score) {
                    const impactSlider = document.querySelector('.impact-slider');
                    if (impactSlider) {
                        impactSlider.value = result.impact_score;
                        handleScoreChange(rowIndex, 'impact', result.impact_score);
                    }
                }

                // Insert Rationale into Technical Constraint/Notes or a new field?
                // User said: "inserts the AI's "Rationale" into the "TECHNICAL CONSTRAINTS / NOTES" textarea (or a new dedicated field if preferred)."
                // I'll append it to Notes for now as it's easier.
                const notesArea = document.querySelector('.styled-textarea');
                if (notesArea) {
                    const rationale = `[AI ASSESSMENT]\nStrategy (${result.strat_score}): ${result.strategy_justification}\nImpact (${result.impact_score}): ${result.impact_justification}\n\n`;
                    notesArea.value = rationale + notesArea.value;
                    handleTechNotesChange(rowIndex, notesArea.value); // Save to backend
                }

                // 4. Reset Button
                btn.innerHTML = '‚úÖ Analysis Complete';
                btn.style.background = '#10b981'; // Green
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.background = '#7e22ce'; // Back to purple
                }, 3000);
            })
            .withFailureHandler(function (error) {
                console.error('AI Error:', error);
                showError('AI Assessment failed: ' + error.message);

                // Reset Button
                btn.innerHTML = '‚ùå Error';
                btn.style.background = '#ef4444'; // Red
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.background = '#7e22ce';
                }, 3000);
            })
            .assessProjectWithAI(rowIndex);
    }

    /**
     * Cancel assignee edit in details panel
     */
    function cancelAssigneeEdit() {
        const ownerDisplay = document.getElementById('ownerDisplay');
        const ownerEdit = document.getElementById('ownerEdit');

        ownerDisplay.style.display = 'flex';
        ownerEdit.style.display = 'none';
    }

    /**
     * Toggle status dropdown in details panel
     */
    function toggleStatusDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('statusDropdown');
        const isVisible = dropdown.style.display === 'block';

        // Close all other dropdowns first
        document.querySelectorAll('.status-dropdown').forEach(d => d.style.display = 'none');

        // Toggle this dropdown
        dropdown.style.display = isVisible ? 'none' : 'block';

        // Add click listener to close dropdown when clicking outside
        if (!isVisible) {
            setTimeout(() => {
                document.addEventListener('click', closeStatusDropdown);
            }, 0);
        }
    }

    /**
     * Close status dropdown when clicking outside
     */
    function closeStatusDropdown() {
        const dropdown = document.getElementById('statusDropdown');
        if (dropdown) {
            dropdown.style.display = 'none';
        }
        document.removeEventListener('click', closeStatusDropdown);
    }

    /**
     * Change Ad Hoc request status
     */
    function changeAdHocStatus(rowIndex, newStatus) {
        const panel = document.getElementById('detailsPanel');
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');

        // Update local data
        row[statusIndex] = newStatus;

        // Close dropdown
        closeStatusDropdown();

        // Update the status badge in the panel
        const statusContainer = document.getElementById('detailStatus');
        statusContainer.innerHTML = `
            <div style="position: relative; display: inline-block;">
                <button 
                    onclick="toggleStatusDropdown(event)" 
                    style="background: none; border: none; padding: 0; cursor: pointer;"
                    aria-label="Change status"
                >
                    ${renderStatusBadge(newStatus)}
                </button>
                <div id="statusDropdown" class="status-dropdown" style="display: none;">
                    <div class="status-dropdown-header">CHANGE STATUS</div>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'New')" data-status="New">
                        <span class="status-dot" style="background: #3b82f6;"></span>
                        New
                        ${newStatus === 'New' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'In Progress')" data-status="In Progress">
                        <span class="status-dot" style="background: #f59e0b;"></span>
                        In Progress
                        ${newStatus === 'In Progress' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'Cancelled')" data-status="Cancelled">
                        <span class="status-dot" style="background: #ef4444;"></span>
                        Cancelled
                        ${newStatus === 'Cancelled' ? '<span style="margin-left: auto; color: #10b981;">‚úì</span>' : ''}
                    </button>
                </div>
            </div>
        `;

        // Update the status in the table row
        const tableRow = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (tableRow) {
            const statusCell = tableRow.querySelector('td:nth-child(2)'); // Status is 2nd column in Ad Hoc
            if (statusCell) {
                statusCell.innerHTML = renderStatusBadge(newStatus);
            }
        }

        // Update database in background
        updateField(rowIndex, 'Status', newStatus);
    }

    /**
     * Save deliverable evidence
     */
    function saveDeliverableEvidence(rowIndex, evidence) {
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const deliverableIndex = headers.indexOf('Deliverable Evidence');

        // Update local data
        row[deliverableIndex] = evidence;

        // Update database
        updateField(rowIndex, 'Deliverable Evidence', evidence);
    }

    /**
     * Save notes
     */
    function saveNotes(rowIndex, notes) {
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const notesIndex = headers.indexOf('Notes');

        // Update local data if Notes column exists
        if (notesIndex !== -1) {
            row[notesIndex] = notes;
        }

        // Update database
        updateField(rowIndex, 'Notes', notes);

        console.log(`Notes saved for row ${rowIndex}: ${notes.substring(0, 50)}...`);
    }

    /**
     * Update notes character count
     */
    function updateNotesCharCount(notes) {
        const charCount = document.getElementById('notesCharCount');
        if (charCount) {
            const length = notes ? notes.length : 0;
            charCount.textContent = `${length} / 1000`;

            // Change color if approaching limit
            if (length > 900) {
                charCount.style.color = 'var(--rose-600)';
            } else if (length > 750) {
                charCount.style.color = 'var(--amber-700)';
            } else {
                charCount.style.color = 'var(--slate-400)';
            }
        }
    }

    /**
     * Mark Ad Hoc request as complete
     */
    function markAdHocComplete(rowIndex) {
        const deliverableInput = document.getElementById('deliverableInput');
        const deliverableValue = deliverableInput ? deliverableInput.value.trim() : '';

        // Validate that deliverable evidence is provided
        if (!deliverableValue) {
            alert('Please provide a link to the dashboard or file in the Deliverable Evidence field before marking as complete.');
            deliverableInput.focus();
            return;
        }

        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;
        const statusIndex = headers.indexOf('Status');
        const deliverableIndex = headers.indexOf('Deliverable Evidence');

        // Update local data
        row[statusIndex] = 'Completed';
        row[deliverableIndex] = deliverableValue;

        // Update the status badge in the panel
        const statusContainer = document.getElementById('detailStatus');
        statusContainer.innerHTML = `
            <div style="position: relative; display: inline-block;">
                <button 
                    onclick="toggleStatusDropdown(event)" 
                    style="background: none; border: none; padding: 0; cursor: pointer;"
                    aria-label="Change status"
                >
                    ${renderStatusBadge('Completed')}
                </button>
                <div id="statusDropdown" class="status-dropdown" style="display: none;">
                    <div class="status-dropdown-header">CHANGE STATUS</div>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'New')" data-status="New">
                        <span class="status-dot" style="background: #3b82f6;"></span>
                        New
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'In Progress')" data-status="In Progress">
                        <span class="status-dot" style="background: #f59e0b;"></span>
                        In Progress
                    </button>
                    <button class="status-dropdown-item" onclick="changeAdHocStatus(${rowIndex}, 'Cancelled')" data-status="Cancelled">
                        <span class="status-dot" style="background: #ef4444;"></span>
                        Cancelled
                    </button>
                </div>
            </div>
        `;

        // Update the status in the table row
        const tableRow = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (tableRow) {
            const statusCell = tableRow.querySelector('td:nth-child(2)'); // Status is 2nd column
            if (statusCell) {
                statusCell.innerHTML = renderStatusBadge('Completed');
            }
        }

        // Update database with both status and deliverable evidence
        const updates = {
            'Status': 'Completed',
            'Deliverable Evidence': deliverableValue
        };

        updateMultipleFields(rowIndex, updates, function () {
            // Show success message
            alert('‚úÖ Request marked as complete!');

            // Close the panel
            closeDetails();

            // Reload data to refresh the table
            setTimeout(() => loadData(currentTab), 300);
        });
    }


    /**
     * ========================================
     * PROJECT WORKFLOW HANDLERS
     * ========================================
     */

    /**
     * Handle AI Scoring (Simulates AI API call)
     */
    /**
     * Render 1-5 Segment Control
     */
    function renderSegmentOptions(rowIndex, type, currentValue) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            const activeClass = i === currentValue ? 'active' : '';
            html += `<button class="segment-btn ${activeClass}" 
                        onclick="handleScoreChange(${rowIndex}, '${type}', ${i}, this)">${i}</button>`;
        }
        return html;
    }

    /**
     * Calculate Average Tech Score
     */
    function calculateAvgTech(scores) {
        const sum = parseFloat(scores.data) + parseFloat(scores.stake) + parseFloat(scores.impl);
        return (sum / 3).toFixed(1);
    }

    /**
     * Calculate Final Score
     */
    function calculateFinalScore(strat, impact, effort) {
        const num = parseFloat(strat) + parseFloat(impact);
        const den = parseFloat(effort);
        if (den === 0) return 0;
        return (num / den).toFixed(1);
    }

    /**
     * Handle ONLY Client-Side UI Updates & Trigger Save
     * (Debounced to prevent API flooding)
     */
    let saveTimeout;
    function handleScoreChange(rowIndex, type, value, btnElement) {
        // 1. Update UI Elements immediately
        if (type === 'strat' || type === 'impact') {
            document.getElementById(`disp-${type}`).textContent = value;
            document.getElementById(`formula-${type}`).innerText = value;
        }

        if (type === 'data' || type === 'stake' || type === 'impl') {
            // Update buttons visual state
            if (btnElement) {
                const parent = btnElement.parentElement;
                parent.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }
        }

        // 2. Gather all current values from DOM (Source of Truth)
        const strat = parseFloat(document.querySelector('.strat-slider').value);
        const impact = parseFloat(document.querySelector('.impact-slider').value);

        // Find active buttons for tech scores
        const getTechVal = (idx) => {
            const row = document.querySelectorAll('.tech-input-row')[idx];
            const active = row.querySelector('.segment-btn.active');
            return active ? parseInt(active.innerText) : 1;
        };

        const dataScore = getTechVal(0);
        const stakeScore = getTechVal(1);
        const implScore = getTechVal(2);

        // 3. Re-Calculate
        const avgTech = calculateAvgTech({ data: dataScore, stake: stakeScore, impl: implScore });
        const finalScore = calculateFinalScore(strat, impact, avgTech);

        // 4. Update Calculation Card
        document.getElementById('disp-avg-tech').textContent = avgTech;
        document.getElementById('formula-eff').innerText = avgTech;
        document.getElementById('disp-final-score').textContent = finalScore;

        // 5. Update Global Data (optimistic)
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;

        // Helper to safe update if col exists
        const safeUpdate = (col, val) => {
            const idx = headers.indexOf(col);
            if (idx !== -1) row[idx] = val;
        };

        safeUpdate('Strategy Score', strat);
        safeUpdate('Impact Score', impact);
        safeUpdate('Data Score', dataScore);
        safeUpdate('Stakeholder Score', stakeScore);
        safeUpdate('Implementation Score', implScore);
        safeUpdate('Tech Effort', avgTech);
        safeUpdate('Final Score', finalScore);

        // 6. Debounced Save to Server
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            const updates = {
                'Strategy Score': strat,
                'Impact Score': impact,
                'Data Score': dataScore,
                'Stakeholder Score': stakeScore,
                'Implementation Score': implScore,
                'Tech Effort': avgTech,
                'Final Score': finalScore
            };

            console.log('Saving scores:', updates);
            updateMultipleFields(rowIndex, updates);
        }, 1000);
    }


    /**
     * Handle Manual Save & Sync
     */
    function handleManualSave(rowIndex) {
        // Safe version with improved syntax
        try {
            clearTimeout(saveTimeout);
        } catch (e) { }

        var btn = document.getElementById('btnManualSave');
        if (btn) {
            btn.textContent = 'Saving...';
            btn.disabled = true;
        }

        var stratInput = document.querySelector('.strat-slider');
        var impactInput = document.querySelector('.impact-slider');

        var strat = stratInput ? parseFloat(stratInput.value) : 0;
        var impact = impactInput ? parseFloat(impactInput.value) : 0;

        // Helper for tech scores
        var getTechVal = function (idx) {
            var row = document.querySelectorAll('.tech-input-row')[idx];
            if (!row) return 1;
            var active = row.querySelector('.segment-btn.active');
            return active ? parseInt(active.innerText) : 1;
        };

        var dataScore = getTechVal(0);
        var stakeScore = getTechVal(1);
        var implScore = getTechVal(2);

        var avgTech = calculateAvgTech({ data: dataScore, stake: stakeScore, impl: implScore });
        var finalScore = calculateFinalScore(strat, impact, avgTech);

        var updates = {
            'Strategy Score': strat,
            'Impact Score': impact,
            'Data Score': dataScore,
            'Stakeholder Score': stakeScore,
            'Implementation Score': implScore,
            'Tech Effort': avgTech,
            'Final Score': finalScore
        };

        updateMultipleFields(rowIndex, updates, function () {
            if (btn) {
                btn.textContent = 'Saved!';
                btn.disabled = false;
                setTimeout(function () { btn.textContent = 'Save Scoring'; }, 2000);
            }

            // Update local model
            if (currentData && currentData.rows && currentData.rows[rowIndex]) {
                var row = currentData.rows[rowIndex];
                var headers = currentData.headers;
                var updateCol = function (col, val) {
                    var idx = headers.indexOf(col);
                    if (idx !== -1) row[idx] = val;
                };
                updateCol('Strategy Score', strat);
                updateCol('Impact Score', impact);
                updateCol('Data Score', dataScore);
                updateCol('Stakeholder Score', stakeScore);
                updateCol('Implementation Score', implScore);
                updateCol('Tech Effort', avgTech);
                updateCol('Final Score', finalScore);
            }

            // Reload data to ensure consistency
            setTimeout(function () { loadData(currentTab); }, 100);
        });
    }

    /**
     * Handle Tech Notes Change
     */
    function handleTechNotesChange(rowIndex, newNotes) {
        updateField(rowIndex, 'Tech Notes', newNotes);
    }

    /**
     * Handle Project Decision (Approve/Reject)
     */
    /**
     * Handle Project Decision (Approve/Reject)
     * Calculates Final Score and writes back to database
     */
    function handleProjectDecision(rowIndex, decision) {
        // Calculate the Final Score one last time to ensure it's fresh
        const row = currentData.rows[rowIndex];
        const headers = currentData.headers;

        // Get latest values from local data (which should be updated by sliders/buttons)
        // OR read from DOM if we want super-safety, but local data is kept in sync by handleScoreChange
        const stratIndex = headers.indexOf('Strategy Score');
        const impactIndex = headers.indexOf('Impact Score');
        const techIndex = headers.indexOf('Tech Effort');

        const strat = parseFloat(row[stratIndex]) || 5;
        const impact = parseFloat(row[impactIndex]) || 5;
        const effort = parseFloat(row[techIndex]) || 1;

        const finalScore = calculateFinalScore(strat, impact, effort);

        // Update local data immediately (optimistic UI)
        const statusIndex = headers.indexOf('Status');
        const finalScoreIndex = headers.indexOf('Final Score');

        row[statusIndex] = decision;
        if (finalScoreIndex !== -1) row[finalScoreIndex] = finalScore;

        // Update the status/score in the panel (without full re-render)
        const statusElement = document.getElementById('detailStatus');
        if (statusElement) {
            statusElement.innerHTML = renderStatusBadge(decision);
        }

        // Update the status in the table row (without full table re-render)
        const tableRow = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (tableRow) {
            const statusCell = tableRow.querySelector('td:nth-child(3)'); // Status is generally 3rd
            if (statusCell) {
                statusCell.innerHTML = renderStatusBadge(decision);
            }
            // Also update score cell if visible? (Maybe unnecessary complexity for now)
        }

        // Update database in background
        const updates = {
            'Status': decision,
            'Final Score': finalScore
        };

        updateMultipleFields(rowIndex, updates, function () {
            console.log(`Decision saved: ${decision}, Final Score: ${finalScore}`);
            // Force reload to ensure sorting/filtering rules apply
            setTimeout(() => loadData(currentTab), 500);
        });
    }

    /**
     * Update multiple fields at once
     */
    function updateMultipleFields(rowIndex, updates, callback) {
        const sheetRowIndex = rowIndex + 1; // +1 for header row

        google.script.run
            .withSuccessHandler(function (result) {
                console.log('Multiple fields updated successfully');

                // Update local data
                const headers = currentData.headers;
                Object.keys(updates).forEach(fieldName => {
                    const fieldIndex = headers.indexOf(fieldName);
                    if (fieldIndex !== -1) {
                        currentData.rows[rowIndex][fieldIndex] = updates[fieldName];
                    }
                });

                if (callback) callback(result);
            })
            .withFailureHandler(function (error) {
                console.error('Error updating fields:', error);
                alert('Failed to update fields. Please try again.');
            })
            .updateRow(currentTab, sheetRowIndex, updates);
    }


    /**
     * Render assignee dropdown
     * @param {string} value - Current assignee
     * @param {number} rowIndex - Row index
     * @returns {string} HTML for dropdown
     */
    function renderAssigneeDropdown(value, rowIndex) {
        const options = teamMembers.map(member => {
            const selected = member === value ? 'selected' : '';
            return `<option value="${escapeHtml(member)}" ${selected}>${escapeHtml(member)}</option>`;
        }).join('');

        return `<select class="editable-select" onchange="updateAssignee(${rowIndex}, this.value)">${options}</select>`;
    }

    /**
     * Render status dropdown
     * @param {string} value - Current status
     * @param {number} rowIndex - Row index
     * @param {string} deliverableEvidence - Current deliverable evidence value
     * @returns {string} HTML for dropdown
     */
    function renderStatusDropdown(value, rowIndex, deliverableEvidence) {
        const statuses = ['New', 'In Progress', 'Completed'];
        const statusClass = getStatusSelectClass(value);

        const options = statuses.map(status => {
            const selected = status === value ? 'selected' : '';
            // Disable "Completed" if no deliverable evidence
            const disabled = (status === 'Completed' && (!deliverableEvidence || deliverableEvidence.trim() === '')) ? 'disabled' : '';
            return `<option value="${status}" ${selected} ${disabled}>${status}</option>`;
        }).join('');

        return `<select class="editable-select ${statusClass}" 
                        onchange="updateStatus(${rowIndex}, this.value)" 
                        data-row-index="${rowIndex}">${options}</select>`;
    }

    /**
     * Render deliverable evidence input
     * @param {string} value - Current value
     * @param {number} rowIndex - Row index
     * @returns {string} HTML for input
     */
    function renderDeliverableInput(value, rowIndex) {
        const displayValue = value || '';
        return `<input type="text" 
                       class="editable-input" 
                       value="${escapeHtml(displayValue)}" 
                       placeholder="Paste link to deliverable..."
                       onblur="updateDeliverable(${rowIndex}, this.value)"
                       data-row-index="${rowIndex}">`;
    }

    /**
     * Format deadline with urgency highlighting
     * @param {string} dateStr - Date string
     * @returns {string} Formatted HTML
     */
    function formatDeadline(dateStr) {
        if (!dateStr) return '<span style="color: var(--gray-light);">‚Äî</span>';

        try {
            const deadline = new Date(dateStr);
            if (isNaN(deadline.getTime())) return escapeHtml(dateStr);

            const now = new Date();
            const diffMs = deadline - now;
            const diffHours = diffMs / (1000 * 60 * 60);
            const diffDays = diffHours / 24;

            let className = 'deadline-normal';
            let urgencyLabel = '';

            if (diffHours < 0) {
                className = 'deadline-critical';
                urgencyLabel = ' ‚ö†Ô∏è OVERDUE';
            } else if (diffHours <= 48) {
                className = 'deadline-critical';
                urgencyLabel = ' üî• 48h';
            } else if (diffDays <= 7) {
                className = 'deadline-warning';
                urgencyLabel = ' ‚ö° 1 week';
            }

            const formattedDate = deadline.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: deadline.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });

            return `<span class="${className}">${formattedDate}${urgencyLabel}</span>`;
        } catch (e) {
            return escapeHtml(dateStr);
        }
    }

    /**
     * Get status select class based on value
     * @param {string} status - Status value
     * @returns {string} CSS class
     */
    function getStatusSelectClass(status) {
        const statusLower = String(status).toLowerCase();
        if (statusLower.includes('new')) return 'status-select-new';
        if (statusLower.includes('progress')) return 'status-select-in-progress';
        if (statusLower.includes('complete')) return 'status-select-completed';
        return '';
    }

    /**
     * Update assignee
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New assignee value
     */
    function updateAssignee(rowIndex, newValue) {
        updateField(rowIndex, 'Assignee', newValue);
    }

    /**
     * Update assignee from table dropdown
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New assignee value
     */
    function updateAssigneeFromTable(rowIndex, newValue) {
        updateField(rowIndex, 'Assignee', newValue, function () {
            // Reload data to refresh the table
            setTimeout(() => loadData(currentTab), 300);
        });
    }

    /**
     * Update status with validation
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New status value
     */
    function updateStatus(rowIndex, newValue) {
        const deliverableIndex = currentData.headers.indexOf('Deliverable Evidence');
        const deliverableValue = currentData.rows[rowIndex][deliverableIndex];

        // Validate on client side
        if (newValue === 'Completed' && (!deliverableValue || deliverableValue.trim() === '')) {
            showError('Cannot mark as Completed without Deliverable Evidence. Please provide a link to the final output.');

            // Reset dropdown to previous value
            const statusIndex = currentData.headers.indexOf('Status');
            const previousValue = currentData.rows[rowIndex][statusIndex];
            const select = document.querySelector(`select[data-row-index="${rowIndex}"]`);
            if (select) {
                select.value = previousValue;
            }
            return;
        }

        updateField(rowIndex, 'Status', newValue, function () {
            // Update the dropdown class after successful update
            const select = document.querySelector(`select[data-row-index="${rowIndex}"]`);
            if (select) {
                select.className = 'editable-select ' + getStatusSelectClass(newValue);
            }

            // If marked as completed, refresh to remove from "My Active Tasks" view
            if (newValue === 'Completed' && currentView === 'myTasks') {
                setTimeout(() => loadData(currentTab), 500);
            }
        });
    }

    /**
     * Update deliverable evidence
     * @param {number} rowIndex - Row index
     * @param {string} newValue - New deliverable value
     */
    function updateDeliverable(rowIndex, newValue) {
        updateField(rowIndex, 'Deliverable Evidence', newValue, function () {
            // Re-enable "Completed" option in status dropdown if deliverable is now provided
            if (newValue && newValue.trim() !== '') {
                const statusSelect = document.querySelector(`select.editable-select[data-row-index="${rowIndex}"]`);
                if (statusSelect) {
                    const completedOption = statusSelect.querySelector('option[value="Completed"]');
                    if (completedOption) {
                        completedOption.disabled = false;
                    }
                }
            }
        });
    }

    /**
     * Generic field update function
     * @param {number} rowIndex - Row index
     * @param {string} columnName - Column name
     * @param {string} newValue - New value
     * @param {Function} callback - Optional callback after successful update
     */
    function updateField(rowIndex, columnName, newValue, callback) {
        const updates = {};
        updates[columnName] = newValue;

        // Show loading indicator (optional)
        console.log(`Updating ${columnName} to "${newValue}" for row ${rowIndex}`);

        google.script.run
            .withSuccessHandler(function (success) {
                if (success) {
                    // Update local data
                    const colIndex = currentData.headers.indexOf(columnName);
                    if (colIndex !== -1) {
                        currentData.rows[rowIndex][colIndex] = newValue;
                    }

                    // Execute callback if provided
                    if (callback) callback();

                    console.log(`Successfully updated ${columnName}`);
                } else {
                    showError(`Failed to update ${columnName}`);
                }
            })
            .withFailureHandler(function (error) {
                showError(`Error updating ${columnName}: ${error.message}`);
                console.error('Update error:', error);
            })
            .updateRow(currentTab, rowIndex + 1, updates);
    }

    /**
     * Format cell content based on column type
     * @param {*} value - Cell value
     * @param {string} header - Column header
     * @returns {string} Formatted HTML
     */
    function formatCell(value, header) {
        // Handle empty values
        if (value === null || value === undefined || value === '') {
            return '<span style="color: var(--gray-light);">‚Äî</span>';
        }

        // Status column (for non-editable views)
        if (header === 'Status') {
            const statusClass = getStatusClass(value);
            return `<span class="status-badge ${statusClass}">${value}</span>`;
        }

        // Priority column
        if (header === 'Priority') {
            const priorityClass = getPriorityClass(value);
            return `<span class="${priorityClass}">${value}</span>`;
        }

        // Email columns
        if (header.includes('Email')) {
            return `<a href="mailto:${value}" style="color: var(--primary); text-decoration: none;">${value}</a>`;
        }

        // Date columns (except Hard Deadline which is handled separately)
        if ((header.includes('Date') || header.includes('Timestamp') || header.includes('Modified')) && header !== 'Hard Deadline') {
            return formatDate(value);
        }

        // Default
        return escapeHtml(String(value));
    }

    /**
     * Get status badge class
     * @param {string} status - Status value
     * @returns {string} CSS class name
     */
    function getStatusClass(status) {
        const statusLower = String(status).toLowerCase();

        if (statusLower.includes('new')) return 'status-new';
        if (statusLower.includes('progress') || statusLower.includes('active')) return 'status-in-progress';
        if (statusLower.includes('complete') || statusLower.includes('done')) return 'status-completed';
        if (statusLower.includes('hold') || statusLower.includes('pending')) return 'status-on-hold';

        return 'status-new';
    }

    /**
     * Get priority class
     * @param {string} priority - Priority value
     * @returns {string} CSS class name
     */
    function getPriorityClass(priority) {
        const priorityLower = String(priority).toLowerCase();

        if (priorityLower.includes('high') || priorityLower.includes('urgent')) return 'priority-high';
        if (priorityLower.includes('medium') || priorityLower.includes('normal')) return 'priority-medium';
        if (priorityLower.includes('low')) return 'priority-low';

        return '';
    }

    /**
     * Format date string
     * @param {string} dateStr - Date string
     * @returns {string} Formatted date
     */
    function formatDate(dateStr) {
        if (!dateStr) return '‚Äî';

        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            // Show relative time for recent dates
            if (diffDays === 0) {
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
                }
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            }

            // Format as date
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        } catch (e) {
            return dateStr;
        }
    }

    /**
     * Escape HTML to prevent XSS (Optimized)
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    const escapeMap = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    const escapeRegex = /[&<>"']/g;
    function escapeHtml(text) {
        if (!text) return '';
        return String(text).replace(escapeRegex, (s) => escapeMap[s]);
    }

    /**
     * Show loading state
     */
    function showLoading() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('dataGridSection').style.display = 'none';
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
    }

    /**
     * Hide loading state
     */
    function hideLoading() {
        document.getElementById('loadingState').classList.add('hidden');
    }

    /**
     * Show empty state
     */
    function showEmptyState() {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('dataGridSection').style.display = 'none';
        document.getElementById('stat-total').textContent = '0';
        document.getElementById('stat-urgent').textContent = '0';
    }

    /**
     * Show error message
     * @param {string} message - Error message
     */
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = `‚ö†Ô∏è ${message}`;
        errorDiv.classList.remove('hidden');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    }

    /**
     * Refresh current view
     */
    function refreshData() {
        loadData(currentTab);
    }

    // Auto-refresh every 5 minutes
    setInterval(refreshData, 5 * 60 * 1000);
</script>